function e(t){return t?(t^16*Math.random()>>t/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,e)}const t={ground:null};function n(){return t}function i(e){return{itemId:e,width:1,height:1,imgSrc:"",displayName:"",description:"",stackSize:-1,metadata:{}}}function o(t,n){const o=t.itemId;if(n?o?n.itemId=o:n.itemId||(n.itemId=e()):n=i(o||e()),"number"==typeof t.width&&(n.width=t.width),"number"==typeof t.height&&(n.height=t.height),"string"==typeof t.imgSrc&&(n.imgSrc=t.imgSrc),"string"==typeof t.displayName&&(n.displayName=t.displayName),"string"==typeof t.description&&(n.description=t.description),"number"==typeof t.stackSize&&(n.stackSize=t.stackSize),"object"==typeof t.metadata)try{n.metadata=JSON.parse(JSON.stringify(t.metadata))}catch(e){n.metadata={}}return n}class s{static from(e){return(new s).copyItem(e)}constructor(){this._itemId=null,this._width=1,this._height=1,this._imageSrc="",this._displayName="",this._description="",this._stackSize=-1,this._metadata={}}copyItemBuilder(e){return this._itemId=e._itemId,this._width=e._width,this._height=e._height,this._imageSrc=e._imageSrc,this._displayName=e._displayName,this._description=e._description,this._stackSize=e._stackSize,this._metadata=JSON.parse(JSON.stringify(e._metadata)),this}copyItem(e){let t=o(e);return this._itemId=t.itemId,this._width=t.width,this._height=t.height,this._imageSrc=t.imgSrc,this._displayName=t.displayName,this._description=t.description,this._stackSize=t.stackSize,this._metadata=t.metadata,this}default(){return this._itemId=null,this._width=1,this._height=1,this._imageSrc="res/images/potion.png",this._displayName="",this._description="",this._stackSize=-1,this._metadata={},this}itemId(e){return this._itemId=e,this}width(e){return this._width=e,this}height(e){return this._height=e,this}imageSrc(e){return this._imageSrc=e,this}displayName(e){return this._displayName=e,this}description(e){return this._description=e,this}stackSize(e){return this._stackSize=e,this}metadata(e,t){return this._metadata[e]=t,this}build(){let t=null!==this._itemId?this._itemId:e();if(!t)throw new Error(`Invalid item id '${t}'.`);let n=Number(this._width),o=Number(this._height);if(!Number.isFinite(n)||!Number.isSafeInteger(n)||n<=0)throw new Error("Invalid item width - must be a finite positive integer.");if(!Number.isFinite(o)||!Number.isSafeInteger(o)||o<=0)throw new Error("Invalid item height - must be a finite positive integer.");let s,r=String(this._imageSrc.trim()),a=String(this._displayName.trim()),l=String(this._description),c=Number(this._stackSize);try{s=JSON.parse(JSON.stringify(this._metadata))}catch(e){throw new Error(`Invalid json for metadata - ${e}`)}let d=i(t);return d.width=n,d.height=o,d.imgSrc=r,d.displayName=a,d.description=l,d.stackSize=c,d.metadata=s,d}}function r(e,t,n,i,o){return{invId:e,type:t,items:{},slots:new Array(n),width:i,height:o,length:n,displayName:"",metadata:{}}}function a(e,t,n){return r(e,"grid",t*n,t,n)}function l(t,n){const i=t.invId||e(),s=t.type||"grid",a=Number(t.width)||1,l=Number(t.height)||1,c=Number(t.length)||1;if(n?(n.invId=i,n.type=s,n.width=a,n.height=l,n.length=c):n=r(i,s,c,a,l),"object"==typeof t.items)for(let e of Object.values(t.items)){let t=o(e);n.items[t.itemId]=e}if(Array.isArray(t.slots)){const e=Math.min(t.slots.length,n.slots.length);for(let i=0;i<e;++i)n.slots[i]=t.slots[i]}if("string"==typeof t.displayName&&(n.displayName=t.displayName),"object"==typeof t.metadata)try{n.metadata=JSON.parse(JSON.stringify(t.metadata))}catch(e){n.metadata={}}return n}function c(e){return e.length}let d={data:{inventory:{},album:{}}},h={item:{},inventory:{},album:{}};function m(){return d}function u(e,t){return t in e.data.inventory}function g(e,t){return e.data.inventory[t]}function p(e,t,n){if(t!==n.invId)throw new Error(`Cannot add inventory '${n.invId}' for mismatched id '${t}'.`);return!(t in e.data.inventory)&&(e.data.inventory[t]=n,y(e,t),!0)}function f(e,t,n){if(t!==n.invId)throw new Error(`Cannot delete inventory '${n.invId}' for mismatched id '${t}'.`);return t in e.data.inventory&&(delete e.data.inventory[t],y(e,t),!0)}function b(e,t,n,i){let o=a(t,n,i);if(!p(e,t,o))throw new Error("Failed to create socket inventory in store.");return o}function v(e,t){let n=function(e){return r(e,"socket",1,1,1)}(t);if(!p(e,t,n))throw new Error("Failed to create socket inventory in store.");return n}function y(e,t){x(e,"inventory",t)}function S(e,t){L("inventory",e,t)}function w(e,t){N("inventory",e,t)}function C(e,t){x(e,"item",t)}function I(e,t){x(e,"album",t)}function k(e,t){L("album",e,t)}function E(e,t){N("album",e,t)}function L(e,t,n){if(!(e in h))throw new Error(`Cannot manage listener for unknown inventory event '${e}'.`);let i=h[e][t];i||(i=[],h[e][t]=i),i.push(n)}function N(e,t,n){if(!(e in h))throw new Error(`Cannot manage listener for unknown inventory event '${e}'.`);const i=h[e][t];if(i){const e=i.indexOf(n);e>=0&&i.splice(e,1)}}function x(e,t,n){if(!(t in h))throw new Error(`Cannot dispatch event for unknown inventory event '${t}'.`);const i=h[t][n];if(i)for(const t of i)t.call(void 0,e,n)}function O(e,t,n,i,o){for(let s=t;s<=i;++s)for(let t=n;t<=o;++t){let n=_(e,s,t);n<0||(e.slots[n]=null)}}function _(e,t,n){if(t<0||n<0)return-1;switch(e.type){case"socket":case"grid":{const i=e.width,o=e.height;return t>=i||n>=o?-1:Math.floor(t)+Math.floor(n)*i}default:throw new Error("Unsupported inventory type for slot coords.")}}function R(e,t){if(t<0)return[-1,-1];switch(e.type){case"socket":case"grid":{const n=e.width;return[t%n,Math.floor(t/n)]}default:throw new Error("Unsupported inventory type for slot coords.")}}function A(e,t,n=0){const i=c(e);for(let o=n;o<i;++o){let n=e.slots[o];if(n&&n===t)return o}return-1}function T(e,t){return!!e.items[t]}function z(e,t,n,i){if(!e)throw new Error("Cannot put item to non-existant inventory.");if(!t)throw new Error("Cannot put null item.");const o=t.itemId;if(o in e.items)throw new Error(`Cannot put item '${o}' that already exists in inventory '${e.invId}'.`);e.items[o]=t,function(e,t,n,i,o,s){for(let r=t;r<=i;++r)for(let t=n;t<=o;++t){let n=_(e,r,t);n<0||(e.slots[n]=s)}}(e,n,i,n+t.width-1,i+t.height-1,o)}function D(e,t,n){return M(e,_(e,t,n))}function M(e,t){return e.slots[t]}function H(e,t){return e.items[t]}function q(e,t,n,i,o){z(B(e,t),n,i,o),y(e,t)}function $(e,t,n){let i=B(e,t);T(i,n)&&(!function(e,t){if(!e)throw new Error("Cannot remove item from non-existant inventory.");if(!(t in e.items))throw new Error(`Cannot remove item '${t}' that does not exist in inventory '${e.invId}'.`);let n=A(e,t);if(n<0)throw new Error(`Failed to remove item '${t}' - missing slot index for item.`);let i=H(e,t),[o,s]=R(e,n);O(e,o,s,o+i.width-1,s+i.height-1),delete e.items[t]}(i,n),y(e,t))}function F(e,t){!function(e){O(e,0,0,e.width-1,e.height-1),e.items={}}(B(e,t)),y(e,t)}function j(e,t,n){let i=B(e,t);return H(i,M(i,n))}function P(e,t,n,i){let o=B(e,t);return H(o,D(o,n,i))}function U(e,t,n,i){return D(B(e,t),n,i)}function J(e,t){const n=B(e,t),i=c(n);for(let e=0;e<i;++e){if(n.slots[e])return!1}return!0}function B(e,t){if(u(e,t))return g(e,t);throw new Error(`Cannot get non-existant inventory '${t}'.`)}function W(e,t,n,i,o,s){const r=g(t,n),a=e.getHeldItem(),l=r.width,c=r.height,d=a.width,h=a.height,m=l-d,u=c-h;if(m<0||u<0)return!1;const p=Math.min(Math.max(0,i),m),f=Math.min(Math.max(0,o),u);let b=null;for(let e=0;e<h;++e)for(let i=0;i<d;++i){let o=U(t,n,p+i,f+e);o&&(b?o!==b&&(s=!1):b=o)}if(s){let i=null,o=-1,s=-1;if(b){let e=B(t,n),r=A(e,b),[a,l]=R(e,r);o=a,s=l,i=H(e,b),$(t,n,b)}return e.clearHeldItem(),q(t,n,a,p,f),i&&e.setHeldItem(i,Math.min(0,o-p),Math.min(0,s-f)),!0}{const[i,o]=function(e,t,n,i,o=(()=>!0)){return function(e,t,n,i,o,s,r,a,l,c){if(Number.isNaN(o)||Number.isNaN(s))throw new TypeError("Maximum coordinates must be a number.");if(n<0||i<0||o<0||s<0)throw new Error("Coordinates must be non-negative.");if(n>o||i>s)throw new Error("Minimum coordinates must be less than maximum coordinates.");if(o!==(65535&o)||s!==(65535&s))throw new Error("Cannot find coordinates in dimensions larger than 2^16.");const d=Array.from({length:4}),h=Array.from({length:2}),m=new Set,u=[l(e,t)];for(;u.length>0;){const e=u.shift(),[t,l]=c(e,h);if(r(t,l))return h;m.add(e);for(const e of a(t,l,d)){if(m.has(e))continue;const[t,r]=c(e,h);t>=n&&r>=i&&t<=o&&r<=s&&u.push(e)}}return h[0]=-1,h[1]=-1,h}(e,t,0,0,n,i,o,K,Y,G)}(p,f,m,u,((e,i)=>function(e,t,n,i,o,s,r=null){for(let a=0;a<s;++a)for(let s=0;s<o;++s){const o=P(e,t,n+s,i+a);if(o&&(!r||o!==r))return!1}return!0}(t,n,e,i,d,h)));return i>=0&&o>=0&&(e.clearHeldItem(),q(t,n,a,i,o),!0)}}function Y(e,t){return(65535&e)<<16|65535&t}function G(e,t){return t[0]=e>>16,t[1]=65535&e,t}function K(e,t,n){return n[0]=Y(e-1,t),n[1]=Y(e,t-1),n[2]=Y(e+1,t),n[3]=Y(e,t+1),n}function X(e,t,n){return Math.trunc((t-e.x)/n)}function V(e,t,n){return Math.trunc((t-e.y)/n)}class Q extends HTMLElement{static get[Symbol.for("templateNode")](){const e=document.createElement("template");return e.innerHTML='\n<inventory-grid invid="cursor"></inventory-grid>\n',Object.defineProperty(this,Symbol.for("templateNode"),{value:e}),e}static get[Symbol.for("styleNode")](){const e=document.createElement("style");return e.innerHTML="\n:host {\n  position: absolute;\n  display: none;\n  filter: brightness(70%);\n}\n",Object.defineProperty(this,Symbol.for("styleNode"),{value:e}),e}static define(e=window.customElements){e.define("inventory-cursor",this)}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.append(this.constructor[Symbol.for("templateNode")].content.cloneNode(!0)),this.shadowRoot.append(this.constructor[Symbol.for("styleNode")].cloneNode(!0)),this.animationHandle=null,this.clientX=0,this.clientY=0,this.startHeldX=0,this.startHeldY=0,this.heldOffsetX=0,this.heldOffsetY=0,this.ignoreFirstPutDown=!1,this.inventoryElement=this.shadowRoot.querySelector("inventory-grid"),this.onAnimationFrame=this.onAnimationFrame.bind(this),this.onMouseMove=this.onMouseMove.bind(this)}get invId(){return this.inventoryElement.invId}connectedCallback(){let e=m();u(e,"cursor")||v(e,"cursor"),document.addEventListener("mousemove",this.onMouseMove),this.animationHandle=requestAnimationFrame(this.onAnimationFrame)}disconnectedCallback(){document.removeEventListener("mousemove",this.onMouseMove),cancelAnimationFrame(this.animationHandle),this.animationHandle=null;let e=m();u(e,"cursor")&&f(e,"cursor",g(e,"cursor"))}onAnimationFrame(){const e=this.clientX,t=this.clientY,n=e+48*this.heldOffsetX,i=t+48*this.heldOffsetY;this.style.setProperty("left",n-24+"px"),this.style.setProperty("top",`calc(${i-24}px - 2rem)`),this.ignoreFirstPutDown&&function(e,t,n,i){const o=n-e,s=i-t;return o*o+s*s}(e,t,this.startHeldX,this.startHeldY)>=100&&(this.ignoreFirstPutDown=!1),this.animationHandle=requestAnimationFrame(this.onAnimationFrame)}onMouseMove(e){this.clientX=e.clientX,this.clientY=e.clientY}pickUp(e,t,n=0,i=0){if(!t)return!1;if(this.hasHeldItem())return!1;let o=m(),s=B(o,e);const r=A(s,t),[a,l]=R(s,r),c=H(s,t);return $(o,e,t),this.setHeldItem(c,a-n,l-i),!0}putDown(e,t,n,i){let o=m();if(!this.getHeldItem())return!1;if(this.ignoreFirstPutDown)return this.ignoreFirstPutDown=!1,!0;switch(B(o,e).type){case"socket":return function(e,t,n,i,o,s){let r=e.getHeldItem(),a=j(t,n,0),l=-1,c=-1;if(a){if(!s)return!1;{let e=B(t,n),i=a.itemId,o=A(e,i),[s,r]=R(e,o);l=s,c=r,a=H(e,i),$(t,n,i)}}return e.clearHeldItem(),q(t,n,r,0,0),a&&e.setHeldItem(a,Math.min(0,l-i),Math.min(0,c-o)),!0}(this,o,e,t,n,i);case"grid":return W(this,o,e,t+this.heldOffsetX,n+this.heldOffsetY,i);default:throw new Error("Unsupported inventory type.")}}hasHeldItem(){return!function(e,t){return!e.slots[t]}(B(m(),this.invId),0)}getHeldItem(){return j(m(),this.invId,0)}setHeldItem(e,t=0,n=0){if(!e)throw new Error("Cannot set held item to null - use clearHeldItem() instead.");if(this.hasHeldItem())throw new Error("Cannot set held item - already holding another item.");q(m(),this.invId,e,0,0),this.style.display="unset",this.ignoreFirstPutDown=!0,this.startHeldX=this.clientX,this.startHeldY=this.clientY,this.heldOffsetX=Math.min(0,t),this.heldOffsetY=Math.min(0,n)}clearHeldItem(){F(m(),this.invId),this.style.display="none",this.ignoreFirstPutDown=!1}}function Z(){return document.querySelector("inventory-cursor")}function ee(e){const{target:t}=e,n=t.invId,i=m();if(J(i,n)){t.removeEventListener("itemchange",ee),t.remove();f(i,n,B(i,n))}}function te(e){const t=Z(),n=t.getHeldItem();n&&(t.clearHeldItem(),ie(n))}function ne(){return n().ground}function ie(t){let n=m();const i=ne(),o=v(n,e());q(n,o.invId,t,0,0);const s=function(e,t){const n=B(e,t),i=document.createElement("inventory-grid");return i.invId=n.invId,i.toggleAttribute("noinput",!0),i.addEventListener("itemchange",ee),i}(m(),o.invId);i.append(s)}function oe(e,t){return le(e,"inv_v1",(e=>l(e,t)))}function se(e,t){return ce("inv_v1",l(e),{},t)}function re(e,t){return le(e,"item_v1",(e=>o(e,t)))}function ae(e,t){let n=o(e);return delete n.itemId,ce("item_v1",n,{},t)}function le(e,t,n){if(e._type===t)return n(e._data);throw new Error(`Invalid json data format for imported type '${t}'.`)}function ce(e,t,n,i){return i||(i={}),i._type=e,i._data=t,i._metadata={timestamp:Date.now(),...n},i}function de(e,t){return ce("album_v1",fe(e),{},t)}function he(e,t){return le(e,"album_v1",(e=>fe(e,t)))}function me(e,t){if(function(e,t){return t in e.data.album}(e,t))return ue(e,t);throw new Error(`Cannot get non-existant album '${t}'.`)}function ue(e,t){return e.data.album[t]}function ge(e,t){let n=pe(t);if(!function(e,t,n){if(t!==n.albumId)throw new Error(`Cannot add album '${n.albumId}' for mismatched id '${t}'.`);return!(t in e.data.album)&&(e.data.album[t]=n,I(e,t),!0)}(e,t,n))throw new Error("Failed to create album in store.");return n}function pe(e){return{albumId:e,items:{}}}function fe(t,n){const i=t.albumId||e();if(n?n.albumId=i:n=pe(i),"object"==typeof t.items)for(let e of Object.values(t.items)){let t=o(e);n.items[t.itemId]=e}return n}function be(e,t,n){let i=me(e,t);const o=n.itemId;i.items[o]=n,I(e,t)}function ve(e,t,n){let i=me(e,t);(function(e,t,n){let i=me(e,t);return n in i.items})(e,t,n)&&(delete i.items[n],I(e,t))}function ye(e,t,n){return me(e,t).items[n]}function Se(e,t){var n;!function(e,t){const n=document.createElement("a"),i=t.indexOf(";");t=`${t.slice(0,Math.max(0,i+1))}headers=Content-Disposition%3A%20attachment%3B%20filename=${e};${t.slice(Math.max(0,i+1))}`,n.setAttribute("href",t),n.setAttribute("download",e),n.style.display="none",document.body.append(n),n.click(),n.remove()}(e,(n=t,`data:text/plain; charset=utf-8,${encodeURIComponent(n)}`))}Q.define();class we{constructor(){this.listeners={}}on(e,t){return this.addEventListener(e,t),this}off(e,t){return this.removeEventListener(e,t),this}once(e,t){const n=t,i=function(){n.apply(void 0,arguments),this.removeEventListener(e,i)}.bind(this);return this.addEventListener(e,i),this}emit(e,...t){return this.dispatchEvent(e,t),this}addEventListener(e,t){const n=this.listeners[e];n?n.push(t):this.listeners[e]=[t]}removeEventListener(e,t){const n=this.listeners[e];if(n){const e=n.indexOf(t);e>=0&&n.splice(e,1)}}getEventListeners(e){const t=this.listeners[e];return t?t.slice():[]}dispatchEvent(e,t){const n=this.listeners[e];if(n)for(const e of n){e.apply(void 0,t)}}clearEventListeners(){this.listeners={}}}function Ce(e){return!e.complete&&(e.resolve.length>0||e.reject.length>0)}async function Ie(e){return new Promise(((t,n)=>{e.complete?e.result?t(e.reason):n(e.reason):(e.resolve.push(t),e.reject.push(n))}))}function ke(e,t){if(e.complete)throw new Error("Cannot resolve pending promise already completed.");{let n=e.resolve;e.complete=!0,e.resolve=[],e.reject=[],e.result=!0,e.reason=t;for(let e of n)e(t)}}function Ee(e,t){if(e.complete)throw new Error("Cannot reject pending promise already completed.");{let n=e.reject;e.complete=!0,e.resolve=[],e.reject=[],e.result=!1,e.reason=t;for(let e of n)e(t)}}function Le(...e){console.log(...e)}const Ne=/a=ice-options:trickle\s\n/g,xe=[{urls:["stun:stun.l.google.com:19302","stun:global.stun.twilio.com:3478"]},{urls:"turn:0.peerjs.com:3478",username:"peerjs",credential:"peerjsp"}],Oe=-1,_e=1,Re=2,Ae=3,Te=4,ze=5;class De extends Error{constructor(e,t){super(t),this.code=e}}const Me={protocol:"wss",host:"0.peerjs.com",path:"/",port:443,key:"peerjs",pingIntervalMillis:5e3};class He{constructor(e,t,n){var i,o,s,r,a;n={...Me,...n},this.callback=t,this.webSocket=null,this.closed=!1,this.opened=!1,this.id=e,this.token=$e(),this.baseUrl=(i=n.protocol,o=n.host,s=n.port,r=n.path,a=n.key,`${i}://${o}:${s}${r}peerjs?key=${a}`),this.pingHandle=null,this.pingInterval=n.pingIntervalMillis,this.activeStatus={complete:!1,result:!1,reason:null,resolve:[],reject:[]},this.onSocketMessage=this.onSocketMessage.bind(this),this.onSocketOpened=this.onSocketOpened.bind(this),this.onSocketClosed=this.onSocketClosed.bind(this),this.onHeartbeatTimeout=this.onHeartbeatTimeout.bind(this)}async open(){if(Le("[SIGNAL]","Opening signaling socket..."),this.closed)throw new Error("Cannot open already closed connection to peerjs server.");if(this.opened)throw new Error("Already opened connection to peerjs server.");if(Ce(this.activeStatus))throw new Error("Already trying to open connection to peerjs server.");const e=`${this.baseUrl}&id=${this.id}&token=${this.token}`,t=new WebSocket(e);return this.webSocket=t,t.addEventListener("message",this.onSocketMessage),t.addEventListener("close",this.onSocketClosed),t.addEventListener("open",this.onSocketOpened),Ie(this.activeStatus)}onSocketOpened(){Le("[SOCKET]","Open!"),this.closed||this.scheduleHeartbeat()}onSocketMessage(e){if(Le("[SOCKET]","Received message:",e.data),this.closed)return;let t;try{t=JSON.parse(e.data)}catch(e){return void this.callback(new Error(`Invalid signaling message from peerjs server: ${e.data}`),null)}const{type:n,payload:i,src:o,dst:s}=t;switch(n){case"OPEN":this.opened||(this.opened=!0,ke(this.activeStatus,this));break;case"ERROR":this.callback(new De(_e,JSON.stringify(i)),null);break;case"ID-TAKEN":this.callback(new De(Re,"The requested signaling id is unavailable."),null);break;case"INVALID-KEY":this.callback(new De(Ae,"The given signaling api key is invalid."),null);break;case"LEAVE":this.callback(new De(Te,"Signaling connection left."),null);break;case"EXPIRE":this.callback(new De(ze,"Signaling connection expired."),null);break;case"OFFER":case"ANSWER":case"CANDIDATE":this.callback(void 0,i,o,s);break;default:this.callback(new De(Oe,`Unknown signaling message from peerjs server: ${JSON.stringify(t)}`),null)}}onSocketClosed(){Le("[SOCKET]","Close!"),this.closed||(this.destroy(),this.closed=!0,this.callback(new Error("Signaling connection closed unexpectedly to peerjs server."),null))}sendCandidateMessage(e,t,n){if(Le("[SIGNAL]","Sending candidate from",e,"to",t),this.closed)return;if(!qe(this.webSocket))return void this.callback(new Error("Cannot send candidate message to un-opened connection."),null);const i=JSON.stringify({type:"CANDIDATE",payload:n,dst:t});this.webSocket.send(i)}sendSignalMessage(e,t,n){const{type:i}=n;if(Le("[SIGNAL]","Sending",i,"from",e,"to",t),this.closed)return;if(!qe(this.webSocket))return void this.callback(new Error("Cannot send signaling message to un-opened connection."),null);let o;switch(i){case"offer":o=JSON.stringify({type:"OFFER",payload:n,dst:t});break;case"answer":o=JSON.stringify({type:"ANSWER",payload:n,dst:t})}this.webSocket.send(o)}sendHeartbeatMessage(){if(Le("[SIGNAL]","Sending heartbeat"),this.closed)return;if(!qe(this.webSocket))return void this.callback(new Error("Cannot send signaling heartbeat to un-opened connection."),null);const e=JSON.stringify({type:"HEARTBEAT"});this.webSocket.send(e)}close(){this.closed||(this.destroy(),this.closed=!0)}scheduleHeartbeat(){this.pingHandle||(this.pingHandle=setTimeout(this.onHeartbeatTimeout,this.pingInterval))}onHeartbeatTimeout(){if(this.closed||!qe(this.webSocket))return;const{pingHandle:e}=this;e&&(clearTimeout(e),this.pingHandle=null),this.sendHeartbeatMessage(),this.scheduleHeartbeat()}destroy(){const{webSocket:e}=this;e||(e.removeEventListener("open",this.onSocketOpened),e.removeEventListener("close",this.onSocketClosed),e.removeEventListener("message",this.onSocketMessage),e.close(),this.token=$e(),this.webSocket=null);const{pingHandle:t}=this;t&&(clearTimeout(t),this.pingHandle=null);const{activeStatus:n}=this;Ce(n)&&Ee(n,new Error("Signaling connection closed.")),this.opened=!1}}function qe(e){return e&&1===e.readyState}function $e(){return Math.random().toString(36).slice(2)}class Fe extends we{constructor(e,t,n,i=5e3){super(),this.signaling=e,this.peerConnection=n,this.localId=t,this.remoteId=null,this.timeout=i,this.pendingCandidates=[],this.completed=!1,this.iceStatus={complete:!1,result:!1,reason:null,resolve:[],reject:[]},this.iceTimeoutHandle=null,this.onIceTimeout=this.onIceTimeout.bind(this),this.onIceCandidate=this.onIceCandidate.bind(this),this.onIceCandidateError=this.onIceCandidateError.bind(this),this.onIceConnectionStateChange=this.onIceConnectionStateChange.bind(this),this.onIceGatheringStateChange=this.onIceGatheringStateChange.bind(this),this.onSignalingStateChange=this.onSignalingStateChange.bind(this),n.addEventListener("icecandidate",this.onIceCandidate),n.addEventListener("icecandidateerror",this.onIceCandidateError),n.addEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),n.addEventListener("icegatheringstatechange",this.onIceGatheringStateChange),n.addEventListener("signalingstatechange",this.onSignalingStateChange)}destroy(){this.iceTimeoutHandle&&(clearTimeout(this.iceTimeoutHandle),this.iceTimeoutHandle=null),this.pendingCandidates.length=0;let e=this.peerConnection;e.removeEventListener("icecandidate",this.onIceCandidate),e.removeEventListener("icecandidateerror",this.onIceCandidateError),e.removeEventListener("iceconnectionstatechange",this.onIceConnectionStateChange),e.removeEventListener("icegatheringstatechange",this.onIceGatheringStateChange),e.removeEventListener("signalingstatechange",this.onSignalingStateChange),this.peerConnection=null,this.completed||(this.completed=!0,Ee(this.iceStatus,new Error("Negotiator closed."))),this.clearEventListeners()}async negotiate(){if(!this.completed)return Ie(this.iceStatus)}addCandidate(e){this.pendingCandidates.push(e),this.remoteId&&this.peerConnection.remoteDescription&&this.onRemoteDescription(this.remoteId)}onRemoteDescription(e){if(this.completed)return;if(this.remoteId&&this.remoteId!==e)return void Le("[NEGOTIATOR]","Already negotiating connection with another remote id.");this.remoteId=e;let t=this.pendingCandidates.slice();this.pendingCandidates.length=0;for(let e of t)this.peerConnection.addIceCandidate(e).then((()=>Le("[NEGOTIATOR]","Received candidate."))).catch((e=>Le("[NEGOTIATOR]","Failed to add candidate.",e)))}onIceComplete(){Le("[NEGOTIATOR]","Completed ICE candidate negotiation."),this.completed=!0,ke(this.iceStatus,void 0)}onIceTimeout(){this.completed||(Le("[NEGOTIATOR]","Timed out negotiation for ICE candidates."),this.onIceComplete())}onIceGatheringStateChange(){Le("[NEGOTIATOR] ICE connection:",this.peerConnection.iceConnectionState,", gathering:",this.peerConnection.iceGatheringState)}onSignalingStateChange(){Le("[NEGOTIATOR]","ICE signaling:",this.peerConnection.signalingState)}onIceCandidate(e){e.candidate?(Le("[NEGOTIATOR]","Sending an ICE candidate."),this.signaling.sendCandidateMessage(this.localId,this.remoteId,e.candidate),this.iceTimeoutHandle||(this.iceTimeoutHandle=setTimeout(this.onIceTimeout,this.timeout))):(Le("[NEGOTIATOR]","End of ICE candidates."),this.completed||this.onIceComplete())}onIceCandidateError(e){Le("[NEGOTIATOR]","ICE error!",e)}onIceConnectionStateChange(e){switch(e.target.iceConnectionState){case"checking":Le("[NEGOTIATOR]","ICE checking...");break;case"connected":Le("[NEGOTIATOR]","ICE connected!"),this.emit("ready");break;case"completed":Le("[NEGOTIATOR]","ICE completed!"),this.emit("ready");break;case"failed":throw new Error("Ice connection failed.");case"closed":throw new Error("Ice connection closed.")}}}class je extends we{constructor(e,t,n){super(),this.options={trickle:!1,rtcConfig:{},answerOptions:{},offerOptions:{},channelOptions:{}},n&&Object.assign(this.options,n),this.opened=!1,this.closed=!1,this.channelReady=!1,this.negotiatorReady=!1,this.localId=e,this.remoteId=null,this.signaling=t,this.connectedStatus=null,this.peerConnection=null,this.negotiator=null,this.dataChannel=null,this.onDataChannelClose=this.onDataChannelClose.bind(this),this.onDataChannelError=this.onDataChannelError.bind(this),this.onDataChannelMessage=this.onDataChannelMessage.bind(this),this.onDataChannelOpen=this.onDataChannelOpen.bind(this)}setDataChannel(e){if(this.dataChannel){const e=this.dataChannel;this.dataChannel=null,e.removeEventListener("message",this.onDataChannelMessage),e.removeEventListener("error",this.onDataChannelError),e.removeEventListener("close",this.onDataChannelClose),e.removeEventListener("open",this.onDataChannelOpen),e.close()}e&&(this.dataChannel=e,e.binaryType="arraybuffer",e.addEventListener("message",this.onDataChannelMessage),e.addEventListener("error",this.onDataChannelError),e.addEventListener("close",this.onDataChannelClose),e.addEventListener("open",this.onDataChannelOpen))}send(e){if(!this.dataChannel)throw new Error("Cannot send message to un-opened connection.");this.dataChannel.send(e)}close(){if(this.closed)throw new Error("Cannot close already closed connection.");this.closed=!0,this.opened=!1,this.connectedStatus&&(Ee(this.connectedStatus,new Error("Connection closed.")),this.connectedStatus=null),this.dataChannel&&this.setDataChannel(null),this.negotiator&&(this.negotiator.destroy(),this.negotiator=null),this.peerConnection&&(this.peerConnection.close(),this.peerConnection=null),this.clearEventListeners()}onSignalingResponse(e,t,n,i){}onDataChannelMessage(e){Le("[CHANNEL]","Received message:",e.data),this.emit("data",e.data)}onDataChannelClose(){Le("[CHANNEL]","Close!"),this.emit("close")}onDataChannelOpen(){Le("[CHANNEL]","Open!"),this.channelReady=!0,this.tryConnectionReady()}onDataChannelError(e){let t=e.error;Le("[CHANNEL]","Error!",t),this.emit("error",t)}tryConnectionStart(){if(this.opened)throw new Error("Cannot open already opened connection.");return this.opened=!1,this.closed=!1,this.connectedStatus={complete:!1,result:!1,reason:null,resolve:[],reject:[]},this.peerConnection=new RTCPeerConnection({iceServers:xe,...this.options.rtcConfig}),this.negotiator=new Fe(this.signaling,this.localId,this.peerConnection),this.negotiator.on("ready",(()=>{this.negotiatorReady=!0,this.tryConnectionReady()})),this}tryConnectionReady(){if(!this.opened&&this.channelReady&&this.negotiatorReady)return this.opened=!0,ke(this.connectedStatus,this),this.emit("open",this),this}}class Pe extends je{constructor(e,t,n){super(e,t,n),this.onNegotiationNeeded=this.onNegotiationNeeded.bind(this)}async connect(e){Le("[LOCAL]","Connecting to",e,"..."),this.remoteId=e,this.tryConnectionStart(),this.peerConnection.addEventListener("negotiationneeded",this.onNegotiationNeeded);const t=this.peerConnection.createDataChannel("data",this.options.channelOptions);return this.setDataChannel(t),Ie(this.connectedStatus)}onNegotiationNeeded(){Le("[LOCAL]","Negotiation needed."),this.performOffer()}onSignalingResponse(e,t,n,i){if(Le("[LOCAL]","Received signal",e,n,i),"answer"===e){const e=t;this.peerConnection.setRemoteDescription(e).then((()=>this.negotiator.onRemoteDescription(this.remoteId))).then((()=>Le("[LOCAL]","Successfully set remote description."))).catch((e=>Le("[LOCAL]","Failed to set remote description.",e)))}else{if("candidate"!==e)throw new Error(`Received invalid response type '${e}' on local connection.`);{const e=t;this.negotiator.addCandidate(e)}}}async performOffer(e){Le("[LOCAL]","Creating offer...");const t=await this.peerConnection.createOffer(e);await this.peerConnection.setLocalDescription(t),this.options.trickle?(Le("[LOCAL]","Trickling ICE..."),this.negotiator.negotiate()):(Le("[LOCAL]","Waiting for ICE to complete..."),t.sdp=t.sdp.replace(Ne,""),await this.negotiator.negotiate()),Le("[LOCAL]","Sending offer..."),this.signaling.sendSignalMessage(this.localId,this.remoteId,this.peerConnection.localDescription||t)}}class Ue extends je{constructor(e,t,n){super(e,t,n),this.onDataChannel=this.onDataChannel.bind(this)}async listen(){return Le("[REMOTE]","Listening..."),this.tryConnectionStart(),this.peerConnection.addEventListener("datachannel",this.onDataChannel),Ie(this.connectedStatus)}onDataChannel(e){Le("[REMOTE]","Received data channel"),this.setDataChannel(e.channel)}onSignalingResponse(e,t,n,i){if(Le("[REMOTE]","Received signal",e,n,i),"offer"===e){this.remoteId=n;const e=t;this.peerConnection.setRemoteDescription(e).then((()=>this.negotiator.onRemoteDescription(this.remoteId))).then((()=>Le("[REMOTE]","Successfully set remote description from offer."))).catch((e=>Le("[REMOTE]","Failed to set remote description from offer.",e))).then((async()=>(await this.performAnswer(),Ie(this.connectedStatus))))}else{if("candidate"!==e)throw new Error(`Received invalid response type '${e}' on remote connection.`);{const e=t;this.negotiator.addCandidate(e)}}}async performAnswer(e){Le("[REMOTE]","Creating answer...");const t=await this.peerConnection.createAnswer(e);await this.peerConnection.setLocalDescription(t),this.options.trickle?(Le("[REMOTE]","Trickling ICE..."),this.negotiator.negotiate()):(Le("[REMOTE]","Waiting for ICE to complete..."),t.sdp=t.sdp.replace(Ne,""),await this.negotiator.negotiate()),Le("[REMOTE]","Sending answer..."),this.signaling.sendSignalMessage(this.localId,this.remoteId,this.peerConnection.localDescription||t)}}class Je extends we{constructor(t=e()){super(),this.id=t,this.closed=!1,this.connections={},this.connectionOptions={},this.onPeerfulLocalConnectionOpen=this.onPeerfulLocalConnectionOpen.bind(this),this.onPeerfulRemoteConnectionOpen=this.onPeerfulRemoteConnectionOpen.bind(this),this.onSignaling=this.onSignaling.bind(this),this.signaling=new He(t,this.onSignaling),this.signalingPromise=this.signaling.open()}close(){this.closed=!0;const e=Object.values(this.connections);this.connections={};for(const t of e)t.close();this.signaling.close()}async connect(e){if(this.id===e)throw new Error("Cannot connect to peer with the same id.");if(this.closed)throw new Error("Cannot connect to peers when already closed.");await this.signalingPromise;const t=new Pe(this.id,this.signaling,this.connectionOptions);this.connections[e]=t;try{await t.connect(e)}catch(t){console.error("Failed to connect to peer.",t),delete this.connections[e]}return this.onPeerfulLocalConnectionOpen(t),this}async listen(){if(this.closed)throw new Error("Cannot listen for peers when already closed.");return await this.signalingPromise,this}resolveRemoteConnection(e){let t=this.connections[e];if(t)return t;let n=new Ue(this.id,this.signaling,this.connectionOptions);return n.listen().then(this.onPeerfulRemoteConnectionOpen),this.connections[e]=n,n}onPeerfulLocalConnectionOpen(e){this.emit("connect",e)}onPeerfulRemoteConnectionOpen(e){this.emit("connect",e)}onSignaling(e,t,n,i){if(e){const t=this.connections[n]||this.connections[i];t&&t.close(),this.emit("error",e)}else if("type"in t){const e=t;switch(e.type){case"offer":{const t=this.resolveRemoteConnection(n),o=new RTCSessionDescription(e);t.onSignalingResponse("offer",o,n,i)}break;case"answer":{const t=this.connections[n];if(!t)return void console.warn("Received signaling attempt when not listening.");const o=new RTCSessionDescription(e);t.onSignalingResponse("answer",o,n,i)}break;default:console.warn("Received unknown signal:",e)}}else if("candidate"in t){const e=t,o=this.resolveRemoteConnection(n),s=new RTCIceCandidate(e);o.onSignalingResponse("candidate",s,n,i)}else console.warn("Received unknown signal:",t)}}class Be{constructor(){this.remoteClients=[],this.localData={},this.onClientConnected=this.onClientConnected.bind(this),this.onClientDisconnected=this.onClientDisconnected.bind(this),this.setup()}setup(){let e;try{e=JSON.parse(localStorage.getItem("server_data"))||{}}catch{e={}}console.log("Loading server data...",e),this.localData=e,setInterval((()=>{localStorage.setItem("server_data",JSON.stringify(this.localData))}),5e3)}getActiveClientNames(){return this.remoteClients.map((e=>e.name))}getActiveClientByName(e){for(let t of this.remoteClients)if(t.name===e)return t;return null}sendItemTo(e,t){let n=this.getActiveClientByName(e);if(!n||!n.connection)return!1;console.log("Sending item to client...",e);let i={type:"gift",message:ae(t)},o=JSON.stringify(i);return n.connection.send(o),!0}onClientConnected(e){console.log("Remote connection established.");let t={connection:e,name:"",element:null,lastHeartbeat:0};this.remoteClients.push(t),e.on("data",(n=>{try{const i=JSON.parse(n);switch(i.type){case"name":{const n=i.message.toLowerCase().replace(/\s/g,"_");if(!n){let t={type:"error",message:"Invalid user name."},n=JSON.stringify(t);return void e.send(n)}console.log("Setting up client...",n),t.lastHeartbeat=performance.now(),t.name=n;const o=`remote_data#${n}`;let s;if(o in this.localData)s=this.localData[o];else{let e=a("main",12,9);e.displayName=n.toUpperCase(),s=se(e)}let r=JSON.stringify({type:"reset",message:s});e.send(r)}break;case"sync":{const n=t.name;if(!n){let t={type:"error",message:"Not yet signed in."},n=JSON.stringify(t);return void e.send(n)}console.log("Syncing client...",n),t.lastHeartbeat=performance.now();const o=`remote_data#${t.name}`,s=i.message;this.localData[o]=s;let r=m();try{if(u(r,o)){let e=g(r,o);oe(s,e),e.invId=o,y(r,o)}else{let e=oe(s);e.invId=o,p(r,o,e);let n=document.createElement("inventory-grid");n.id=o,n.invId=o,t.element=n,document.querySelector("#workspace").appendChild(n)}}catch(e){console.error(`Failed to load client inventory - ${e}`)}}break;default:{console.error(`Found unknown message from client - ${n}`);let t={type:"error",message:"Unknown message."},i=JSON.stringify(t);e.send(i)}}}catch(e){console.error(`Found invalid message from client - ${n}`,e)}}))}onClientDisconnected(e){let t=!1;for(let n=0;n<this.remoteClients.length;++n){let i=this.remoteClients[n];if(i.connection===e){console.log("Disconnecting client...",i.name),this.remoteClients.splice(n,1);const e=`remote_data#${i.name}`;try{let t=m();if(u(t,e)){f(t,e,g(t,e))}if(i.element){let e=i.element;e.parentElement.removeChild(e)}}catch(e){console.error(`Failed to unload client inventory - ${e}`)}t=!0;break}}t||console.error(`Unable to disconnect unknown connection - ${e.localId}:${e.remoteId}`)}}class We{constructor(){this.remoteServer=null,this.localData={},this.onClientConnected=this.onClientConnected.bind(this),this.onClientDisconnected=this.onClientDisconnected.bind(this)}setup(e){let t;for(;!t;)t=window.prompt("Who Art Thou? (cannot be changed yet, sry)"),t||window.alert("Invalid name.");e.send(JSON.stringify({type:"name",message:t})),setInterval((()=>{const t=m();if(!u(t,"main"))return;const n={type:"sync",message:se(B(t,"main"))},i=JSON.stringify(n);e.send(i)}),1e3)}onClientConnected(e){console.log("Local connection established."),this.remoteServer={connection:e,data:null},e.on("data",(t=>{try{const n=JSON.parse(t);switch(n.type){case"reset":{this.remoteServer.data=n.message;const e=m();u(e,"main")||b(m(),"main",12,9);let t=B(m(),"main");oe(n.message,t),y(e,t.invId)}break;case"gift":ie(re(n.message)),window.alert("You received a gift! Remember to pick it up before closing the browser!");break;case"error":window.alert(`Oops! Server error message: ${t.message}`),e.close();break;default:console.error(`Found unknown message from server - ${t}`)}}catch(e){console.error("Found invalid message from server - "+t,e)}})),this.setup(e)}onClientDisconnected(e){this.remoteServer=null,window.alert("Connection lost! Please refresh the browser and try again.")}}async function Ye(e){if(!e.server){const t=new Je;e.server={peerful:t,instance:new Be},t.on("connect",(t=>{console.log("Client connection established."),e.server.instance.onClientConnected(t),t.on("error",(e=>{console.error(`Client connection errored: ${e}`),t.close()})),t.on("close",(()=>{console.error("Client connection closed."),e.server.instance.onClientDisconnected(t)}))})),t.listen().then((()=>window.alert("Server started!"))).catch((e=>window.alert(e)))}const{peerful:t}=e.server,n=function(e){return`${location.origin}${location.pathname}?id=${e.id}`}(t);await async function(e){await navigator.clipboard.writeText(e)}(n),window.alert(`Link copied!\n${n}`),document.querySelector("#onlineStatus").classList.toggle("active",!0)}function Ge(e){const t=new URLSearchParams(e.search);return t.has("id")?t.get("id"):null}function Ke(){const e=document.querySelector("#editor");try{let t=e.getSocketedItem();t&&(be(m(),"main",t),e.clearEditor())}catch(e){console.error("Failed to export item",e)}}function Xe(){const e=document.querySelector("#editor");try{let t=e.getSocketedItem();if(t){let e=ae(t);Se(`${t.displayName||"New Item"}.json`,JSON.stringify(e,null,4))}}catch(e){console.error("Failed to export item",e)}}function Ve(){const e=document.querySelector("#editor");try{let t=e.getSocketedItem();if(t){const e=n();if(e.server&&e.server.instance){let n=e.server.instance,i=window.prompt(`Who do you want to send it to?\n - ${n.getActiveClientNames().join("\n - ")}`).trim().toLowerCase();e.server.instance.sendItemTo(i,t)}}}catch(e){console.error("Failed to export item",e)}}function Qe(){const e=document.querySelector("#editor");let t=e.getSocketedItem();t&&(ie(t),e.clearEditor())}function Ze(e){document.querySelector("#album").changeView(e.target.value)}function et(e){let t=document.querySelector(".sidebar");t.classList.contains("expand")?t.classList.remove("expand","open"):t.classList.add("expand","open")}function tt(e){const t=document.querySelector("#album"),n=ue(m(),t.albumId);if(n){const t=Date.now();try{const e=de(n);Se(`satchel-album-data-${t}.json`,JSON.stringify(e,null,4))}catch(e){console.error(e)}}}function nt(){document.querySelector(".sidebar").classList.toggle("open")}function it(){window.confirm("Clear all items on the ground?")&&function(){const e=ne().querySelectorAll("inventory-grid");let t=m();for(const n of e)F(t,n.invId)}()}function ot(){if(document.querySelector("#cloudButton").toggleAttribute("disabled",!0),Boolean(Ge(window.location))){(async function(e){const t=Ge(window.location);if(!t)return!1;if(!e.client){const t=new Je;e.client={peerful:t,instance:new We},t.on("connect",(t=>{console.log("Client connection established."),e.client.instance.onClientConnected(t),t.on("error",(e=>{console.error(`Client connection errored: ${e}`),t.close()})),t.on("close",(()=>{console.error("Client connection closed."),e.client.instance.onClientDisconnected(t)}))}))}const{peerful:n}=e.client;try{await n.connect(t)}catch(e){throw window.alert("Oh no! Failed to connect to server!"),e}return window.alert("Hooray! Connected to server!"),document.querySelector("#onlineStatus").classList.toggle("active",!0),!0})(n()).catch((e=>{window.alert("Could not connect: "+e),document.querySelector("#cloudButton").toggleAttribute("disabled",!1)}))}else{Ye(n()).then((()=>{document.querySelector("#actionSendToPlayer").toggleAttribute("disabled",!1)})).catch((e=>{window.alert("Could not connect: "+e)})).finally((()=>{document.querySelector("#cloudButton").toggleAttribute("disabled",!1)}))}}function st(){const e=Date.now();if(function(){const e=n();return Boolean(e.server)}()){let t;try{t=JSON.parse(localStorage.getItem("server_data"))}catch{t={}}const n=ce("server_v1",t,{});Se(`satchel-server-data-${e}.json`,JSON.stringify(n,null,4))}else{const t=se(B(m(),"main"));Se(`satchel-client-data-${e}.json`,JSON.stringify(t,null,4))}}function rt(){document.querySelector("#uploadInput").click()}async function at(e){const t=e.target.files[0];let i;try{i=JSON.parse(await t.text())}catch{window.alert("Cannot load file with invalid json format.")}switch(i._type){case"inv_v1":{const e=m();oe(i,B(e,"main")),y(e,"main")}break;case"album_v1":{const e=m();he(i,me(e,"main")),I(e,"main")}break;case"item_v1":{const e=m();let t=me(e,"main"),n=re(i);be(e,t.albumId,n)}break;case"client_v1":throw new Error("Not yet implemented.");case"server_v1":{const e=i._data;localStorage.setItem("server_data",JSON.stringify(e));const t=n();t.server&&t.server.instance&&(t.server.instance.localData=e)}break;default:window.alert("Cannot load json with unknown data type.")}}function lt(e,t){if(Object.prototype.hasOwnProperty.call(e,t)){const n=e[t];delete e[t],e[t]=n}}window.addEventListener("DOMContentLoaded",(()=>{document.querySelector("#editButton").addEventListener("click",nt),document.querySelector("#deleteButton").addEventListener("click",it),document.querySelector("#cloudButton").addEventListener("click",ot),document.querySelector("#downloadButton").addEventListener("click",st),document.querySelector("#uploadButton").addEventListener("click",rt),document.querySelector("#uploadInput").addEventListener("change",at),document.querySelector("#actionExportToFile").addEventListener("click",Xe),document.querySelector("#actionSendToPlayer").addEventListener("click",Ve),document.querySelector("#actionSaveToAlbum").addEventListener("click",Ke),document.querySelector("#actionAlbumView").addEventListener("change",Ze),document.querySelector("#actionAlbumOpen").addEventListener("click",et),document.querySelector("#actionAlbumExport").addEventListener("click",tt),document.querySelector("#actionDropToGround").addEventListener("click",Qe)}));class ct extends HTMLElement{static get[Symbol.for("templateNode")](){const e=document.createElement("template");return e.innerHTML='\n<figure class="container">\n  <div class="innerContainer">\n    <img src="res/images/scroll.png">\n    <figcaption></figcaption>\n    <label id="stackSize">1</label>\n  </div>\n</figure>\n',Object.defineProperty(this,Symbol.for("templateNode"),{value:e}),e}static get[Symbol.for("styleNode")](){const e=document.createElement("style");return e.innerHTML="\n:host {\n  --background-color: rgba(0, 0, 0, 0.1);\n  --hover-color: rgba(0, 0, 0, 0.2);\n  --itemX: 0;\n  --itemY: 0;\n  --itemWidth: 1;\n  --itemHeight: 1;\n  /* var(--item-unit-size) is inherited from parent container. */\n}\n.container {\n  display: inline-block;\n  position: absolute;\n  left: calc(var(--itemX) * var(--item-unit-size));\n  top: calc(var(--itemY) * var(--item-unit-size));\n  width: calc(var(--itemWidth) * var(--item-unit-size));\n  height: calc(var(--itemHeight) * var(--item-unit-size));\n  padding: 0;\n  margin: 0;\n  user-select: none;\n  box-shadow: 0 0 0 rgba(0, 0, 0, 0);\n  transition: box-shadow 0.1s ease;\n  background-color: var(--background-color);\n}\n.container:hover {\n  background-color: var(--hover-color);\n  z-index: 1;\n}\n\n.innerContainer {\n  position: relative;\n  width: 100%;\n  height: 100%;\n}\nimg {\n  width: 100%;\n  height: 100%;\n  object-fit: contain;\n}\nfigcaption {\n  position: absolute;\n  left: 0;\n  right: 0;\n  bottom: 0;\n  top: unset;\n  opacity: 0;\n  color: white;\n  background-color: rgba(0, 0, 0, 0.7);\n  text-align: center;\n  text-overflow: ellipsis;\n  white-space: nowrap;\n  overflow: hidden;\n}\nfigcaption.vertical {\n  top: 0;\n  bottom: 0;\n  left: 0;\n  right: unset;\n  writing-mode: vertical-rl;\n}\n.container:hover figcaption {\n  opacity: 1;\n}\n\n#stackSize {\n  position: absolute;\n  right: 0.2em;\n  top: 0;\n  text-align: right;\n  text-shadow: 1px 1px 3px black;\n}\n",Object.defineProperty(this,Symbol.for("styleNode"),{value:e}),e}static define(e=window.customElements){e.define("inventory-item",this)}get invId(){return this._invId}get itemId(){return this._itemId}get container(){return this._containerElement}constructor(e,t,n){if(super(),!e)throw new Error("Missing container for item element.");if(!t)throw new Error("Missing inventory id for item element.");if(!n)throw new Error("Missing item id for item element.");if(e.invId!==t)throw new Error("Cannot create item element with mismatched container and inventory id.");if(!T(B(m(),t),n))throw new Error("Cannot create item element with item id not in given inventory.");this.attachShadow({mode:"open"}),this.shadowRoot.append(this.constructor[Symbol.for("templateNode")].content.cloneNode(!0)),this.shadowRoot.append(this.constructor[Symbol.for("styleNode")].cloneNode(!0)),this._containerElement=e,this._invId=t,this._itemId=n,this._image=this.shadowRoot.querySelector("img"),this._caption=this.shadowRoot.querySelector("figcaption"),this._stackSize=this.shadowRoot.querySelector("#stackSize"),this.onItemChange=this.onItemChange.bind(this),this.onMouseDown=this.onMouseDown.bind(this),this.onContextMenu=this.onContextMenu.bind(this)}connectedCallback(){var e,t;this.addEventListener("mousedown",this.onMouseDown),this.addEventListener("contextmenu",this.onContextMenu),e=this.itemId,t=this.onItemChange,L("item",e,t),this.onItemChange(m(),this.itemId)}disconnectedCallback(){var e,t;this.removeEventListener("mousedown",this.onMouseDown),this.removeEventListener("contextmenu",this.onContextMenu),e=this.itemId,t=this.onItemChange,N("item",e,t)}onItemChange(e,t){const n=B(e,this._containerElement.invId),i=A(n,t),[o,s]=R(n,i),r=H(n,t);this.style.setProperty("--itemX",`${o}`),this.style.setProperty("--itemY",`${s}`),this.style.setProperty("--itemWidth",`${r.width}`),this.style.setProperty("--itemHeight",`${r.height}`);const a=r.displayName||"Item";this.title=a,this._image.src=r.imgSrc,this._image.alt=a,this._caption.textContent=r.displayName,this._caption.classList.toggle("vertical",r.width<r.height),r.stackSize>=0?this._stackSize.textContent=`тип${r.stackSize}`:this._stackSize.textContent=""}onMouseDown(e){if(0===e.button)return function(e,t,n){const i=t.container;if(i.hasAttribute("nooutput"))return;const o=i._container.getBoundingClientRect(),s=X(o,e.clientX,n),r=V(o,e.clientY,n);return Z().pickUp(i.invId,t.itemId,s,r)?(document.activeElement.blur(),e.preventDefault(),e.stopPropagation(),!1):void 0}(e,this,48)}onContextMenu(e){let t=new CustomEvent("itemcontext",{bubbles:!0,composed:!0,detail:{clientX:e.clientX,clientY:e.clientY,element:this,container:this.container,invId:this.invId,itemId:this.itemId}});return this.dispatchEvent(t),e.preventDefault(),e.stopPropagation(),!1}}ct.define();class dt extends HTMLElement{static get[Symbol.for("templateNode")](){const e=document.createElement("template");return e.innerHTML='\n<article>\n  <h2></h2>\n  <section class="container grid">\n    <slot></slot>\n  </section>\n</article>\n',Object.defineProperty(this,Symbol.for("templateNode"),{value:e}),e}static get[Symbol.for("styleNode")](){const e=document.createElement("style");return e.innerHTML="\n:host {\n  --background-color: #7f6b50;\n  --outline-color: #352e25;\n  --title-color: #662200;\n  --grid-color: rgba(0, 0, 0, 0.2);\n  --container-width: 1;\n  --container-height: 1;\n  --item-unit-size: 48px;\n}\narticle {\n  position: relative;\n  display: inline-block;\n  width: calc(var(--container-width) * var(--item-unit-size));\n  transition: width var(--transition-duration) ease;\n  margin-top: 2rem;\n  margin-right: 0.5rem;\n  margin-bottom: 0.5rem;\n}\nh2 {\n  position: absolute;\n  top: 2rem;\n  left: 0;\n  right: 0;\n  font-size: 0.9rem;\n  padding-bottom: 2rem;\n  margin: 0;\n  overflow: hidden;\n  text-overflow: ellipsis;\n  border-radius: 1em;\n  text-align: center;\n  color: white;\n  background-color: var(--title-color);\n  transform: translateY(-100%);\n  box-shadow: 0.4rem 0.4rem 0 0 var(--outline-color);\n}\n.container {\n  position: relative;\n  width: 100%;\n  height: calc(var(--container-height) * var(--item-unit-size));\n  background-color: var(--background-color);\n  border-radius: 1rem;\n  box-shadow: 0.4rem 0.4rem 0 0 var(--outline-color);\n  overflow: hidden;\n}\n.flattop {\n  border-top-right-radius: 0rem;\n  border-top-left-radius: 0rem;\n}\n.grid {\n  background-size: var(--item-unit-size) var(--item-unit-size);\n  background-position: -1px -1px;\n  background-image:\n    linear-gradient(to right, var(--grid-color), transparent 1px),\n    linear-gradient(to bottom, var(--grid-color), transparent 1px);\n}\n",Object.defineProperty(this,Symbol.for("styleNode"),{value:e}),e}static define(e=window.customElements){e.define("inventory-grid",this)}static get observedAttributes(){return["invid","init"]}get invId(){return this._invId}set invId(e){this.setAttribute("invid",e)}get init(){return this._init}set init(e){this.setAttribute("init",e)}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.append(this.constructor[Symbol.for("templateNode")].content.cloneNode(!0)),this.shadowRoot.append(this.constructor[Symbol.for("styleNode")].cloneNode(!0)),this._invId=void 0,this._init=void 0,this._root=this.shadowRoot.querySelector("article"),this._itemSlot=this.shadowRoot.querySelector(".container slot"),this._container=this.shadowRoot.querySelector(".container"),this._containerTitle=this.shadowRoot.querySelector("h2"),this.onInventoryChange=this.onInventoryChange.bind(this),this.onMouseUp=this.onMouseUp.bind(this),this.onContextMenu=this.onContextMenu.bind(this)}connectedCallback(){this._container.addEventListener("mouseup",this.onMouseUp),this._container.addEventListener("contextmenu",this.onContextMenu);let e=this._invId;if(e){let t=m();S(e,this.onInventoryChange),this.onInventoryChange(t,e)}lt(this,"invId"),lt(this,"init")}disconnectedCallback(){this._container.removeEventListener("mouseup",this.onMouseUp),this._container.removeEventListener("contextmenu",this.onContextMenu);const e=this._invId;e&&w(e,this.onInventoryChange)}attributeChangedCallback(t,n,i){switch(t){case"init":{const t=m();let n=this.invId;if(n||(n=e(),this.invId=n),"socket"===i)v(t,n);else{if(!i.startsWith("grid"))throw new Error("Unknown init type for inventory-grid.");{let e=i.indexOf("x");b(t,n,Number(i.substring(4,e))||1,Number(i.substring(e+1))||1)}}}break;case"invid":{const e=m(),t=this._invId,n=i;t!==n&&(this._invId=n,t&&w(t,this.onInventoryChange),n&&(S(n,this.onInventoryChange),this.onInventoryChange(e,n)))}}}onInventoryChange(e,t){const n=g(e,t);if(!n)return this.style.setProperty("--container-width","0"),void this.style.setProperty("--container-height","0");const i=n.type;let o=n.width,s=n.height;if("socket"===i){const n=j(e,t,0);n?(o=n.width,s=n.height):(o=1,s=1)}this.style.setProperty("--container-width",`${o}`),this.style.setProperty("--container-height",`${s}`);const r=n.displayName;this._containerTitle.textContent=r,this._container.classList.toggle("flattop",Boolean(r));const a={};for(const e of this._itemSlot.assignedNodes()){const t=e.itemId;"string"==typeof t&&(a[t]=e)}const l=this._itemSlot.cloneNode(!1);for(const e of function(e){return Object.keys(e.items)}(n)){let n;n=e in a?a[e]:new ct(this,t,e),l.append(n)}this._itemSlot.replaceWith(l),this._itemSlot=l,this.dispatchEvent(new CustomEvent("itemchange",{composed:!0,bubbles:!1}))}onMouseUp(e){if(0===e.button)return function(e,t,n){if(t.hasAttribute("noinput"))return;const i=!t.hasAttribute("nooutput"),o=t._container.getBoundingClientRect(),s=X(o,e.clientX,n),r=V(o,e.clientY,n);return Z().putDown(t.invId,s,r,i)?(document.activeElement.blur(),e.preventDefault(),e.stopPropagation(),!1):void 0}(e,this,48)}onContextMenu(e){return e.preventDefault(),e.stopPropagation(),!1}}dt.define();const ht=/(.*)\s+x([0-9]+)\s*$/;class mt extends HTMLElement{static get[Symbol.for("templateNode")](){const e=document.createElement("template");return e.innerHTML='\n<dialog>\n  <textarea id="detail"></textarea>\n</dialog>\n',Object.defineProperty(this,Symbol.for("templateNode"),{value:e}),e}static get[Symbol.for("styleNode")](){const e=document.createElement("style");return e.innerHTML="\n:host {\n  position: absolute;\n  top: 0;\n  left: 0;\n  z-index: 10;\n}\n\ndialog {\n  padding: 0.2em;\n  border: none;\n  border-radius: 0.2em;\n}\n\ndialog[open] {\n  display: flex;\n}\n\ntextarea {\n  flex: 1;\n  border: none;\n  height: 10em;\n}\n",Object.defineProperty(this,Symbol.for("styleNode"),{value:e}),e}static define(e=window.customElements){e.define("item-detail-editor",this)}static get observedAttributes(){return["open"]}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.append(this.constructor[Symbol.for("templateNode")].content.cloneNode(!0)),this.shadowRoot.append(this.constructor[Symbol.for("styleNode")].cloneNode(!0)),this._invId=null,this._itemId=null,this.dialog=this.shadowRoot.querySelector("dialog"),this.inputDetail=this.shadowRoot.querySelector("#detail"),this.onBlur=this.onBlur.bind(this)}connectedCallback(){lt(this,"open"),this.inputDetail.addEventListener("blur",this.onBlur)}disconnectedCallback(){this.inputDetail.removeEventListener("blur",this.onBlur)}attributeChangedCallback(e,t,n){if("open"===e)this.dialog.toggleAttribute("open",null!==n)}onBlur(){if(this.open(0,0,!1),!this._invId||!this._itemId)return;const e=this._invId,t=this._itemId;this._invId=null,this._itemId=null;let n=m(),i=H(B(n,e),t),o=this.inputDetail.value,s=o.indexOf("#");if(s>=0){let e=o.indexOf("\n");e<0&&(e=o.length);let t,n=o.substring(s+1,e);try{let[e,i,o]=ht.exec(n);t=Number.parseInt(o),n=i}catch(e){t=-1}i.stackSize=t,i.displayName=n.trim(),o=o.substring(e+1)}else i.stackSize=-1,i.displayName="";i.description=o,C(n,t)}open(e,t,n,i,o){if(!o)return void this.dialog.toggleAttribute("open",!1);this._invId=e,this._itemId=t,this.style.left=`${n}px`,this.style.top=`${i}px`,this.dialog.toggleAttribute("open",o);let s=H(B(m(),e),t),r="";const a=s.displayName,l=s.stackSize,c=s.description;(a||l>=0)&&(r+="#",a&&(r+=` ${a}`),l>=0&&(r+=` x${l}`)),c&&(r+=`\n${c}`),this.inputDetail.value=r,this.inputDetail.focus(),this.inputDetail.setSelectionRange(r.length,r.length),this.inputDetail.scrollTo({top:0})}}mt.define();const ut={"satchel:blade":"res/images/blade.png","satchel:potion":"res/images/potion.png","satchel:scroll":"res/images/scroll.png"};class gt extends HTMLElement{static get[Symbol.for("templateNode")](){const e=document.createElement("template");return e.innerHTML='<fieldset class="container">\n  <legend>Foundry</legend>\n\n  \x3c!-- Content Elements --\x3e\n  <inventory-grid init="socket" id="socketInventory"></inventory-grid>\n\n  \x3c!-- UI Elements --\x3e\n  <fieldset id="fieldsetSize" disabled>\n    <legend>Size</legend>\n    <div class="labels">\n      <span class="toggle">\n        <input type="radio" name="sizeIndex" id="itemSize1" value=1 tabindex=-1>\n        <label for="itemSize1" title="Small" tabindex=0>\n          <img src="res/spoke.svg">\n        </label>\n      </span>\n      <span class="toggle">\n        <input type="radio" name="sizeIndex" id="itemSize2" value=2 checked tabindex=-1>\n        <label for="itemSize2" title="Medium" tabindex=0>\n          <img src="res/onehand.svg">\n        </label>\n      </span>\n      <span class="toggle">\n        <input type="radio" name="sizeIndex" id="itemSize3" value=3 tabindex=-1>\n        <label for="itemSize3" title="Large" tabindex=0>\n          <img src="res/twohand.svg">\n        </label>\n      </span>\n    </div>\n    <input type="number" name="width" id="itemWidth" hidden value=2>\n    <input type="number" name="height" id="itemHeight" hidden value=2>\n  </fieldset>\n\n  <output id="outputSize" disabled>\n    <span id="outputSizeWidth">2</span>\n    <span>тип</span>\n    <span id="outputSizeHeight">2</span>\n  </output>\n\n  <fieldset id="fieldsetShape" disabled>\n    <legend>Shape</legend>\n    <div class="labels">\n      <span class="toggle">\n        <input type="checkbox" name="stackable" id="itemStackable" tabindex=-1>\n        <label for="itemStackable" tabindex=0>\n          <img src="res/grain.svg" title="Stackable" alt="Stackable">\n        </label>\n      </span>\n      <span class="toggle">\n        <input type="checkbox" name="long" id="itemLong" tabindex=-1>\n        <label for="itemLong" tabindex=0>\n          <img src="res/height.svg" title="Long" alt="Long">\n        </label>\n      </span>\n      <span class="toggle">\n        <input type="checkbox" name="flat" id="itemFlat" tabindex=-1>\n        <label for="itemFlat" tabindex=0>\n          <img src="res/flatten.svg" title="Flat" alt="Flat">\n        </label>\n      </span>\n      <span class="toggle">\n        <input type="checkbox" name="heavy" id="itemHeavy" tabindex=-1>\n        <label for="itemHeavy" tabindex=0>\n          <img src="res/scale.svg" title="Heavy" alt="Heavy">\n        </label>\n      </span>\n    </div>\n  </fieldset>\n\n  <fieldset id="fieldsetStyle" disabled>\n    <legend>Style</legend>\n    <input type="url" name="imageSrc" id="itemImage">\n    <label>\n      <img src="res/image.svg" title="image">\n    </label>\n  </fieldset>\n  \n  <button id="newItem">\n    <img src="res/add.svg" title="New" alt="New">\n  </button>\n\n  <input name="invId" id="itemInvId" hidden>\n  <input name="itemId" id="itemItemId" hidden>\n</fieldset>\n',Object.defineProperty(this,Symbol.for("templateNode"),{value:e}),e}static get[Symbol.for("styleNode")](){const e=document.createElement("style");return e.innerHTML=":host {\n  display: block;\n}\n.container {\n  position: relative;\n  padding-bottom: 2em;\n}\ninput {\n  font-family: monospace;\n}\n\n#fieldsetSize {\n  position: absolute;\n  top: 0;\n  left: 0;\n  border: none;\n  padding: 0;\n}\n#fieldsetSize > legend {\n  display: none;\n}\n#outputSize {\n  position: absolute;\n  left: 0.5em;\n  bottom: 0;\n}\n\n#fieldsetShape {\n  position: absolute;\n  top: 0;\n  right: 0.25em;\n  border: none;\n  padding: 0;\n}\n#fieldsetShape > legend {\n  display: none;\n}\n\n#fieldsetStyle {\n  position: absolute;\n  bottom: 0;\n  left: 0;\n  right: 0;\n  border: none;\n  padding: 0;\n}\n#fieldsetStyle > legend {\n  display: none;\n}\n#fieldsetStyle input {\n  width: 30%;\n  vertical-align: top;\n}\n\n#newItem {\n  position: absolute;\n  bottom: 0;\n  right: 0.25em;\n  padding: 0;\n  background: none;\n  border: none;\n}\n\nfieldset {\n  display: block;\n  text-align: center;\n}\nfieldset:disabled {\n  visibility: hidden;\n}\noutput[disabled] {\n  visibility: hidden;\n}\n\n.labels {\n  display: flex;\n  text-align: center;\n}\n.labels > * {\n  flex: 1;\n}\n\n.toggle {\n  margin-bottom: 0.2em;\n}\n.toggle > input {\n  margin: 0;\n  opacity: 0;\n  width: 0;\n  height: 0;\n}\n.toggle > label {\n  opacity: 0.3;\n  border-bottom: 0.2em solid transparent;\n}\n.toggle > input:checked + label {\n  opacity: 1;\n  border-color: white;\n}\n",Object.defineProperty(this,Symbol.for("styleNode"),{value:e}),e}static define(e=window.customElements){e.define("item-editor",this)}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.append(this.constructor[Symbol.for("templateNode")].content.cloneNode(!0)),this.shadowRoot.append(this.constructor[Symbol.for("styleNode")].cloneNode(!0)),this.socketInventory=this.shadowRoot.querySelector("#socketInventory"),this.itemSize1=this.shadowRoot.querySelector("#itemSize1"),this.itemSize2=this.shadowRoot.querySelector("#itemSize2"),this.itemSize3=this.shadowRoot.querySelector("#itemSize3"),this.itemStackable=this.shadowRoot.querySelector("#itemStackable"),this.itemFlat=this.shadowRoot.querySelector("#itemFlat"),this.itemLong=this.shadowRoot.querySelector("#itemLong"),this.itemHeavy=this.shadowRoot.querySelector("#itemHeavy"),this.itemImage=this.shadowRoot.querySelector("#itemImage"),this.itemItemId=this.shadowRoot.querySelector("#itemItemId"),this.itemInvId=this.shadowRoot.querySelector("#itemInvId"),this.itemWidth=this.shadowRoot.querySelector("#itemWidth"),this.itemHeight=this.shadowRoot.querySelector("#itemHeight"),this.labelSize1=this.shadowRoot.querySelector('label[for="itemSize1"]'),this.labelSize2=this.shadowRoot.querySelector('label[for="itemSize2"]'),this.labelSize3=this.shadowRoot.querySelector('label[for="itemSize3"]'),this.labelStackable=this.shadowRoot.querySelector('label[for="itemStackable"]'),this.labelFlat=this.shadowRoot.querySelector('label[for="itemFlat"]'),this.labelLong=this.shadowRoot.querySelector('label[for="itemLong"]'),this.labelHeavy=this.shadowRoot.querySelector('label[for="itemHeavy"]'),this.outputSizeWidth=this.shadowRoot.querySelector("#outputSizeWidth"),this.outputSizeHeight=this.shadowRoot.querySelector("#outputSizeHeight"),this.buttonNew=this.shadowRoot.querySelector("#newItem"),this.container=this.shadowRoot.querySelector(".container"),this.fieldsetSize=this.shadowRoot.querySelector("#fieldsetSize"),this.fieldsetShape=this.shadowRoot.querySelector("#fieldsetShape"),this.fieldsetStyle=this.shadowRoot.querySelector("#fieldsetStyle"),this.outputSize=this.shadowRoot.querySelector("#outputSize"),this.onSizeChange=this.onSizeChange.bind(this),this.onStackableChange=this.onStackableChange.bind(this),this.onImageChange=this.onImageChange.bind(this),this.onButtonNew=this.onButtonNew.bind(this),this.onItemDrop=this.onItemDrop.bind(this),this.onLabelKeyUp=this.onLabelKeyUp.bind(this),this.onSocketInventoryChange=this.onSocketInventoryChange.bind(this)}connectedCallback(){this.itemSize1.addEventListener("click",this.onSizeChange),this.itemSize2.addEventListener("click",this.onSizeChange),this.itemSize3.addEventListener("click",this.onSizeChange),this.itemStackable.addEventListener("change",this.onStackableChange),this.itemFlat.addEventListener("change",this.onSizeChange),this.itemLong.addEventListener("change",this.onSizeChange),this.itemHeavy.addEventListener("change",this.onSizeChange),this.itemImage.addEventListener("change",this.onImageChange),this.labelSize1.addEventListener("keyup",this.onLabelKeyUp),this.labelSize2.addEventListener("keyup",this.onLabelKeyUp),this.labelSize3.addEventListener("keyup",this.onLabelKeyUp),this.labelStackable.addEventListener("keyup",this.onLabelKeyUp),this.labelFlat.addEventListener("keyup",this.onLabelKeyUp),this.labelLong.addEventListener("keyup",this.onLabelKeyUp),this.labelHeavy.addEventListener("keyup",this.onLabelKeyUp),this.buttonNew.addEventListener("click",this.onButtonNew),this.container.addEventListener("mouseup",this.onItemDrop),S(this.socketInventory.invId,this.onSocketInventoryChange)}disconnectedCallback(){this.itemSize1.removeEventListener("click",this.onSizeChange),this.itemSize2.removeEventListener("click",this.onSizeChange),this.itemSize3.removeEventListener("click",this.onSizeChange),this.itemStackable.removeEventListener("change",this.onStackableChange),this.itemFlat.removeEventListener("change",this.onSizeChange),this.itemLong.removeEventListener("change",this.onSizeChange),this.itemHeavy.removeEventListener("change",this.onSizeChange),this.itemImage.removeEventListener("change",this.onImageChange),this.labelSize1.removeEventListener("keyup",this.onLabelKeyUp),this.labelSize2.removeEventListener("keyup",this.onLabelKeyUp),this.labelSize3.removeEventListener("keyup",this.onLabelKeyUp),this.labelStackable.removeEventListener("keyup",this.onLabelKeyUp),this.labelFlat.removeEventListener("keyup",this.onLabelKeyUp),this.labelLong.removeEventListener("keyup",this.onLabelKeyUp),this.labelHeavy.removeEventListener("keyup",this.onLabelKeyUp),this.buttonNew.removeEventListener("click",this.onButtonNew),this.container.removeEventListener("mouseup",this.onItemDrop),w(this.socketInventory.invId,this.onSocketInventoryChange)}setupEditor(e,t,n){const i=n.width,o=n.height;this.itemInvId.value=e,this.itemItemId.value=t,this.itemWidth.value=i,this.itemHeight.value=o,this.itemImage.value=n.imgSrc;let s=n.metadata.sizeIndex;if(!s)if(i===o)switch(i){case 1:s=1;break;case 2:s=2;break;case 4:s=3;break;default:s=0}else s=0;this.itemSize1.checked=1===s,this.itemSize2.checked=2===s,this.itemSize3.checked=3===s,this.itemFlat.checked=n.metadata.flat||!1,this.itemLong.checked=n.metadata.long||!1,this.itemHeavy.checked=n.metadata.heavy||!1,this.itemStackable.checked=n.stackSize>=0,this.outputSizeWidth.textContent=`${i}`,this.outputSizeHeight.textContent=`${o}`,this.fieldsetSize.toggleAttribute("disabled",!1),this.fieldsetShape.toggleAttribute("disabled",!1),this.fieldsetStyle.toggleAttribute("disabled",!1),this.outputSize.toggleAttribute("disabled",!1)}clearEditor(){this.itemInvId.value="",this.itemItemId.value="";const e=m(),t=this.socketInventory.invId;J(e,t)||F(e,t),this.fieldsetSize.toggleAttribute("disabled",!0),this.fieldsetShape.toggleAttribute("disabled",!0),this.fieldsetStyle.toggleAttribute("disabled",!0),this.outputSize.toggleAttribute("disabled",!0)}getSocketedItem(){const e=m(),t=this.socketInventory.invId;return u(e,t)?j(e,t,0):null}onSocketInventoryChange(){let e=this.getSocketedItem();e?this.setupEditor(this.socketInventory.invId,e.itemId,e):this.clearEditor()}onButtonNew(t){t.stopPropagation(),t.preventDefault();const n=new s,i=this.getSocketedItem();let o=m();if(i){ie(n.copyItem(i).itemId(e()).build())}else{let e=n.default().width(2).height(2).build();q(o,this.socketInventory.invId,e,0,0)}return!1}onLabelKeyUp(e){"Enter"===e.code&&e.target.click()}onSizeChange(){const e=this.itemSize1.checked?1:this.itemSize2.checked?2:this.itemSize3.checked?3:0,t=this.itemFlat.checked,n=this.itemLong.checked,i=this.itemHeavy.checked;this.itemStackable.checked;const[o,s]=function(e,t,n,i){let o,s;e=Math.max(1,Math.trunc(e)),i&&(e+=1);if(e<=1)o=1,s=1;else{let t=2*(e-1);o=t,s=t}t&&!n&&(o+=1,s=Math.ceil(s/2));n&&!t&&(o=Math.ceil(o/2),s+=1);return[o,s]}(e,t,n,i);this.outputSizeWidth.textContent=`${o}`,this.outputSizeHeight.textContent=`${s}`,this.itemWidth.value=`${o}`,this.itemHeight.value=`${s}`,this.itemImage.placeholder=pt(o,s);const r=this.getSocketedItem();if(r){r.width=o,r.height=s,r.metadata.sizeIndex=e,r.metadata.flat=t,r.metadata.long=n,r.metadata.heavy=i,r.imgSrc=this.itemImage.value||this.itemImage.placeholder;const a=m();C(a,r.itemId),y(a,this.socketInventory.invId)}}onStackableChange(){let e=this.getSocketedItem();if(e){let t;t=this.itemStackable.checked?1:-1,e.stackSize=t,C(m(),e.itemId)}}onImageChange(){let e=this.getSocketedItem();if(e){let t=e.width,n=e.height,i=this.itemImage.value;if(i&&i.length<64){let e=i.toLowerCase().trim();if(e in ut)i=ut[e];else if(e.startsWith("satchel:")){i=void 0;let t=`Invalid satchel image file '${e}'. Can only be one of:\n - ${Object.keys(ut).join("\n - ")}`;throw window.alert(t),new Error(t)}}i||(i=pt(t,n,this.itemStackable.checked)),e.imgSrc=i,C(m(),e.itemId)}}onItemDrop(e){const t=this.socketInventory;if(Z().putDown(t.invId,0,0,!0))return e.preventDefault(),e.stopPropagation(),!1}}function pt(e,t,n){return e<t?"res/images/blade.png":e>t?"res/images/scroll.png":"res/images/potion.png"}gt.define();class ft extends HTMLElement{static get[Symbol.for("templateNode")](){const e=document.createElement("template");return e.innerHTML='\n<div class="container">\n  <article class="front">\n    <h2>\n      <span class="headerTitle" id="itemName">Item</span>\n      <span class="headerIcon"></span>\n    </h2>\n    <section class="portrait" id="itemImage"></section>\n    <section class="subtitle">\n      <label>\n        <span>Item | Physical | Crafted</span>\n      </label>\n      <span class="spacer"></span>\n      <output id="itemSize">\n        <span>(</span>\n        <span id="itemWidth"></span>\n        <span>,</span>\n        <span id="itemHeight"></span>\n        <span>)</span>\n      </output>\n      <output id="itemStackable">\n        <span>&nbsp;тип</span>\n        <span id="itemStackSize"></span>\n      </output>\n    </section>\n    <section class="description" id="itemDescription"></section>\n    <section class="credits" id="itemAuthor"></section>\n  </article>\n</div>\n<div class="toolbar">\n  <button id="create">Create</button>\n  <button id="modify">Modify</button>\n  <button id="export">Export</button>\n  <button id="delete">Delete</button>\n</div>\n',Object.defineProperty(this,Symbol.for("templateNode"),{value:e}),e}static get[Symbol.for("styleNode")](){const e=document.createElement("style");return e.innerHTML="\n:host {\n  display: inline-block;\n  position: relative;\n  width: 18em;\n  height: 22em;\n  --text-color: #FFFFFF;\n  --outline-color: #333333;\n  --background-image: url(res/images/paper.jpg);\n  --portrait-image: url(res/images/potion.png);\n}\n\n.hidden {\n  display: none;\n}\n\n/* TOOLBAR */\n\n.toolbar {\n  position: absolute;\n  top: 0;\n  right: 0;\n}\n\n/* DIFFERENT VIEWS */\n\n:host(:not([detailed])) section.description {\n  display: none;\n}\n\n:host([minified]) {\n  height: unset;\n}\n:host([minified]) .front {\n  position: relative;\n}\n:host([minified]) .back {\n  display: none;\n}\n:host([minified]) .front h2 {\n  display: flex;\n}\n:host([minified]) section.portrait {\n  display: none;\n}\n:host([minified]) .headerTitle {\n  flex: 1;\n  margin-right: 0.25em;\n}\n:host([minified]) .headerIcon {\n  display: inline-block;\n  width: 20%;\n  background: var(--portrait-image);\n  background-size: contain;\n  background-repeat: no-repeat;\n  background-position: center;\n  border-radius: 0.5em;\n  transform: scale(150%);\n}\n\n.front {\n  width: calc(100% - 2em);\n  height: calc(100% - 2em);\n\n  border-radius: 1em;\n  border-color: var(--outline-color);\n  border-style: solid;\n  border-width: 0.5em;\n\n  padding: 0.5em;\n}\n\n/* CARD LAYOUT */\n\n.container {\n  width: 100%;\n  height: 100%;\n}\n\n/* FRONT CARD LAYOUT */\n\n.front {\n  background: var(--background-image);\n  color: var(--outline-color);\n  display: flex;\n  flex-direction: column;\n}\n\n.front h2 {\n  margin: 0;\n  margin-bottom: 0.25em;\n  padding: 0.5em;\n\n  border-radius: 0.5em;\n  background-color: var(--outline-color);\n  color: var(--text-color);\n\n  text-align: left;\n}\n\nsection.portrait {\n  background: var(--portrait-image);\n  background-size: contain;\n  background-repeat: no-repeat;\n  background-position: center;\n  flex: 1;\n\n  border-radius: 0.5em;\n}\n\nsection.subtitle {\n  display: flex;\n  position: relative;\n  margin-top: 0.25em;\n\n  font-size: 0.6em;\n\n  border-radius: 0.5em;\n  background-color: var(--outline-color);\n  color: var(--text-color);\n  padding: 0.5em;\n}\nsection.subtitle > * {\n  text-align: left;\n}\nsection.subtitle > *:last-child {\n  text-align: right;\n}\n.spacer {\n  flex: 1;\n}\n\nsection.description {\n  background-color: var(--text-color);\n  color: var(--outline-color);\n  margin: 0 0.25em;\n  margin-top: 0.75em;\n  margin-bottom: 0.25em;\n  padding: 0.5em;\n  border-radius: 0.5em;\n  flex: 1;\n  overflow-y: auto;\n  text-align: left;\n  outline: 4px ridge var(--outline-color);\n}\n\nsection.description p {\n  margin: 0;\n}\n\nsection.credits {\n  text-align: left;\n  font-size: 0.5em;\n  margin-bottom: -1em;\n  opacity: 0.8;\n}\n\n/* BACK CARD LAYOUT */\n\n.back {\n  background-color: var(--outline-color);\n  color: var(--text-color);\n}\n",Object.defineProperty(this,Symbol.for("styleNode"),{value:e}),e}static define(e=window.customElements){e.define("card-stock",this)}static get observedAttributes(){return["minified","detailed"]}get minified(){return this._minified}set minified(e){this.setAttribute("minified",e?"true":"false")}get detailed(){return this._detailed}set detailed(e){this.setAttribute("detailed",e?"true":"false")}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.append(this.constructor[Symbol.for("templateNode")].content.cloneNode(!0)),this.shadowRoot.append(this.constructor[Symbol.for("styleNode")].cloneNode(!0)),this.itemData=null,this.itemId="",this._minified=!1,this._detailed=!1,this.itemName=this.shadowRoot.querySelector("#itemName"),this.itemDescription=this.shadowRoot.querySelector("#itemDescription"),this.itemWidth=this.shadowRoot.querySelector("#itemWidth"),this.itemHeight=this.shadowRoot.querySelector("#itemHeight"),this.itemStackSize=this.shadowRoot.querySelector("#itemStackSize"),this.itemStackable=this.shadowRoot.querySelector("#itemStackable"),this.itemAuthor=this.shadowRoot.querySelector("#itemAuthor"),this.itemImage=this.shadowRoot.querySelector("#itemImage"),this.toolbarCreate=this.shadowRoot.querySelector("#create"),this.toolbarModify=this.shadowRoot.querySelector("#modify"),this.toolbarDelete=this.shadowRoot.querySelector("#delete"),this.toolbarExport=this.shadowRoot.querySelector("#export"),this.onToolbarCreate=this.onToolbarCreate.bind(this),this.onToolbarModify=this.onToolbarModify.bind(this),this.onToolbarDelete=this.onToolbarDelete.bind(this),this.onToolbarExport=this.onToolbarExport.bind(this)}connectedCallback(){lt(this,"flipped"),lt(this,"minified"),lt(this,"detailed"),this.toolbarCreate.addEventListener("click",this.onToolbarCreate),this.toolbarModify.addEventListener("click",this.onToolbarModify),this.toolbarDelete.addEventListener("click",this.onToolbarDelete),this.toolbarExport.addEventListener("click",this.onToolbarExport)}disconnectedCallback(){this.toolbarCreate.removeEventListener("click",this.onToolbarCreate),this.toolbarModify.removeEventListener("click",this.onToolbarModify),this.toolbarDelete.removeEventListener("click",this.onToolbarDelete),this.toolbarExport.removeEventListener("click",this.onToolbarExport)}setItem(e){this.itemName.textContent=e.displayName||"Item",this.itemDescription.textContent=e.description,this.itemWidth.textContent=e.width,this.itemHeight.textContent=e.height,e.stackSize>=0?(this.itemStackable.classList.toggle("hidden",!1),this.itemStackSize.textContent=e.stackSize):this.itemStackable.classList.toggle("hidden",!0),this.style.setProperty("--portrait-image",`url(${e.imgSrc})`);let t=ae(e),n=function(e=""){let t=0;for(let n=0,i=e.length;n<i;n++)t=Math.imul(31,t)+e.charCodeAt(n)|0;return t}(JSON.stringify(t._data));return this.itemAuthor.textContent=`#${n} DungeonMaster`,this.itemData=t,this.itemId=e.itemId,this}getItem(){return re(this.itemData)}onToolbarCreate(){ie(this.getItem())}onToolbarModify(){const e=this.getItem(),t=document.querySelector("item-editor");if(t){const n=t.socketInventory.invId;q(m(),n,e,0,0)}this.onToolbarDelete()}onToolbarDelete(){if(this.itemId){ve(m(),"main",this.itemId)}}onToolbarExport(){const e=this.getItem();let t=ae(e);Se(`${e.displayName||"New Item"}.json`,JSON.stringify(t,null,4))}}ft.define();class bt extends HTMLElement{static get[Symbol.for("templateNode")](){const e=document.createElement("template");return e.innerHTML="\n<article>\n  <slot></slot>\n</article>\n",Object.defineProperty(this,Symbol.for("templateNode"),{value:e}),e}static get[Symbol.for("styleNode")](){const e=document.createElement("style");return e.innerHTML="\n",Object.defineProperty(this,Symbol.for("styleNode"),{value:e}),e}static define(e=window.customElements){e.define("card-album",this)}static get observedAttributes(){return["albumid"]}get albumId(){return this._albumId}set albumId(e){this.setAttribute("albumid",e)}constructor(){super(),this.attachShadow({mode:"open"}),this.shadowRoot.append(this.constructor[Symbol.for("templateNode")].content.cloneNode(!0)),this.shadowRoot.append(this.constructor[Symbol.for("styleNode")].cloneNode(!0)),this._albumId=void 0,this._viewMode="default",this._root=this.shadowRoot.querySelector("article"),this._itemSlot=this.shadowRoot.querySelector("slot"),this.onAlbumChange=this.onAlbumChange.bind(this)}changeView(e){switch(e){case"default":for(let e of this._itemSlot.querySelectorAll("card-stock"))e.toggleAttribute("minified",!1),e.toggleAttribute("detailed",!1);break;case"compact":for(let e of this._itemSlot.querySelectorAll("card-stock"))e.toggleAttribute("minified",!0),e.toggleAttribute("detailed",!1);break;case"detailed":for(let e of this._itemSlot.querySelectorAll("card-stock"))e.toggleAttribute("minified",!0),e.toggleAttribute("detailed",!0);break;case"full":for(let e of this._itemSlot.querySelectorAll("card-stock"))e.toggleAttribute("minified",!1),e.toggleAttribute("detailed",!0)}this._viewMode=e}connectedCallback(){let e=this._albumId;if(e){let t=m();k(e,this.onAlbumChange),this.onAlbumChange(t,e)}lt(this,"albumId")}disconnectedCallback(){const e=this._albumId;e&&E(e,this.onAlbumChange)}attributeChangedCallback(e,t,n){if("albumid"===e){const e=m(),t=this._albumId,i=n;t!==i&&(this._albumId=i,t&&E(t,this.onAlbumChange),i&&(k(i,this.onAlbumChange),this.onAlbumChange(e,i)))}}onAlbumChange(e,t){if(!ue(e,t))return;const n={};for(const e of this._itemSlot.assignedNodes()){const t=e.itemId;"string"==typeof t&&(n[t]=e)}const i=this._itemSlot.cloneNode(!1);let o=function(e,t){let n=me(e,t);return Object.keys(n.items)}(e,t).sort(((n,i)=>(ye(e,t,n).displayName||"").localeCompare(ye(e,t,i).displayName||"")));for(const s of o){let o;o=s in n?n[s]:(new ft).setItem(ye(e,t,s)),i.append(o)}this._itemSlot.replaceWith(i),this._itemSlot=i,this.changeView(this._viewMode)}}bt.define();window.addEventListener("DOMContentLoaded",(()=>{document.querySelector("#appVersion").textContent="v1.0.22",document.addEventListener("itemcontext",(e=>{e.preventDefault(),e.stopPropagation();const t=document.querySelector("#detailEditor"),{invId:n,itemId:i,clientX:o,clientY:s}=e.detail;return n&&i&&t.open(n,i,o,s,!0),!1}));const e=m();!function(e){const t=n();t.ground&&document.removeEventListener("mouseup",te),e&&(t.ground=e,document.addEventListener("mouseup",te))}(document.querySelector("#ground"));const t=b(e,"main",12,9),i=ge(e,"main");let o=localStorage.getItem("satchel_data_v2");if(o)try{!function(e,t){l(e,t)}(JSON.parse(o),t),t.displayName="",y(e,t.invId)}catch(e){console.error("Failed to load inventory from localStorage."),console.error(e)}let s=localStorage.getItem("satchel_album_v1");if(s)try{he(JSON.parse(s),i),I(e,i.albumId)}catch(e){console.error("Failed to load album from localStorage."),console.error(e)}setInterval((()=>{console.log("Autosave...");try{let t=function(e,t){return t||(t={}),Object.assign(t,l(e)),t}(B(e,"main"),{});localStorage.setItem("satchel_data_v2",JSON.stringify(t))}catch(e){console.error(e)}try{let t=de(me(e,"main"));localStorage.setItem("satchel_album_v1",JSON.stringify(t))}catch(e){console.error(e)}}),1e3)}));
