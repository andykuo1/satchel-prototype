<!DOCTYPE html>
<html>

<head>
    <title>Satchel</title>

    <style>
        html, body {
            margin: 0;
        }

        body {
            display: flex;
            flex-direction: column;
            width: 100vw;
            height: 100vh;
            background-image: url("./res/images/wood.jpg");
            background-size: 30rem;
            background-repeat: repeat;
            background-color: #211B1C;
            color: #FFFFFF;
            overflow: hidden;
            font-family: Georgia, 'Times New Roman', Times, serif;
            box-shadow: inset 0 0 16rem #000000;
        }

        .foreground {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            overflow: hidden;
            z-index: 5;
        }

        #holding {
            --transition-duration: 0;
        }

        #ground {
            position: relative;
            padding: 1rem;
            border: 1rem dashed rgba(0, 0, 0, 0.2);
        }
    </style>
    
    <script type="module" src="./src/inventory/InventoryGrid.js"></script>
    <script type="module" src="./src/inventory/InventoryItem.js"></script>
</head>
<body>
    <style>
        body {
            display: flex;
            flex-direction: column;
        }
        .content {
            flex: 1;
            height: 0;
        }
        header, footer {
            z-index: 1;
        }
    </style>
    <header>
        <style>
            header {
                display: flex;
                flex-direction: row;
                align-items: center;
                padding: 0 2em;
            }
            .spacer {
                flex: 1;
            }
            .toolbar {
                overflow-x: auto;
            }
            .toolbar button {
                background: none;
                border: none;
            }
        </style>
        <h1>Satchel</h1>
        <div class="spacer"></div>
        <div class="toolbar">
            <button id="deleteButton">
                <img src="res/delete.svg" alt="delete" width="40">
            </button>
            <button id="settingsButton">
                <img src="res/settings.svg" alt="settings" width="40">
            </button>
            <script type="module">
                import { clearGround } from './src/inventory/GroundHelper.js';
                
                window.addEventListener('DOMContentLoaded', () => {
                    document.querySelector('#settingsButton').addEventListener('click', onSettingsClick);
                    document.querySelector('#deleteButton').addEventListener('click', onDeleteClick);
                });

                function onSettingsClick() {
                    document.querySelector('#settingsContent').classList.toggle('open');
                }

                function onDeleteClick() {
                    clearGround();
                }
            </script>
        </div>
    </header>
    <div class="content">
        <main class="workspace">
            <style>
                .content {
                    position: relative;
                    text-align: center;
                    display: flex;
                }
                .workspace {
                    overflow: auto;
                    flex: 1;
                }
                .sidebar {
                    background: #333333;
                    position: absolute;
                    top: 0;
                    right: 0;
                    transform: translateX(100%);
                    transition: transform 0.3s ease;
                }
                .sidebar.open {
                    transform: translateX(0%);
                }
            </style>
            <inventory-grid id="main" name="main" type="grid" rows=9 cols=12></inventory-grid>
            <div id="ground"></div>
        </main>
        <div class="sidebar" id="settingsContent">
            <style>
                #itemDetailSet, #itemFinishSet {
                    display: flex;
                    flex-direction: column;
                }
            </style>
            <form id="itemBuilder">
                <legend>Item Builder</legend>
                <fieldset id="itemSizeSet">
                    <legend>Size</legend>
                    <input type="radio" id="itemSize0" name="itemSize" value="tiny">
                    <label for="itemSize0">Tiny</label>
                    <input type="radio" id="itemSize1" name="itemSize" value="small" checked>
                    <label for="itemSize1">Small</label>
                    <input type="radio" id="itemSize2" name="itemSize" value="medium">
                    <label for="itemSize2">Medium</label>
                    <input type="radio" id="itemSize3" name="itemSize" value="large">
                    <label for="itemSize3">Large</label>
                    <input type="radio" id="itemSize4" name="itemSize" value="huge">
                    <label for="itemSize4">Huge</label>
                </fieldset>
                <fieldset id="itemTraitSet">
                    <legend>Traits</legend>
                    <input type="checkbox" id="itemTrait0" name="itemTrait" value="flat">
                    <label for="itemTrait0">Flat</label>
                    <input type="checkbox" id="itemTrait1" name="itemTrait" value="long">
                    <label for="itemTrait1">Long</label>
                    <input type="checkbox" id="itemTrait2" name="itemTrait" value="heavy">
                    <label for="itemTrait2">Heavy</label>
                </fieldset>
                <fieldset id="itemDetailSet">
                    <legend>Details</legend>
                    <label for="itemName">Name</label>
                    <input type="text" id="itemName" name="itemName" value="Item">
                    <label for="itemDetail">Description</label>
                    <textarea id="itemDetail" name="itemDetail"></textarea>
                    <label for="itemPortrait" name="itemPortrait">Image</label>
                    <input id="itemPortrait" type="file">
                </fieldset>
                <br>
                <fieldset id="itemFinishSet">
                    <button id="itemResetButton">Reset to Default</button>
                    <input type="submit" value="Build Item">
                </fieldset>
            </form>
        </div>
    </div>
    <footer style="font-family: monospace; opacity: 0.6;">
        <small>
            Made with ‚ù§ by Andrew Kuo.
        </small>
    </footer>
    <div class="foreground">
        <inventory-grid name="cursor" id="holding" type="socket"></inventory-grid>
    </div>

    <script type="module">
        import { setCursorElement } from './src/inventory/CursorHelper.js';
        import { setGroundContainer, dropOnGround } from './src/inventory/GroundHelper.js';
        import { createItem, getInventoryStore } from './src/inventory/InventoryStore.js';
        import { BACKPACK } from './src/inventory/Items.js';
        import { InventoryItem } from './src/inventory/InventoryItem.js';
        import RopeImage from '../../res/rope.js';

        window.addEventListener('DOMContentLoaded', () => {
            document.querySelector('#itemBuilder').addEventListener('submit', onItemBuild);
            document.querySelector('#itemResetButton').addEventListener('click', onItemReset);
        });

        function onItemBuild(e) {
            console.log(getInventoryStore());
            let result = {
                w: 1,
                h: 1,
                displayName: 'Item',
                imgSrc: RopeImage,
                metadata: {
                    detail: 'A mundane item.',
                    category: 'Container',
                    size: 'small',
                    traits: []
                }
            };
            let data = new FormData(e.target);
            for(let entry of data) {
                let [key, value] = entry;
                switch(key) {
                    case 'itemSize':
                        result.metadata.size = value;
                        break;
                    case 'itemTrait':
                        result.metadata.traits.push(value);
                    case 'itemName':
                        result.displayName = value;
                        break;
                    case 'itemPortrait':
                        result.imgSrc = value;
                        break;
                    case 'itemDetail':
                        result.metadata.detail = value;
                        break;
                }
            }

            let size = result.metadata.size;
            if (result.metadata.traits.includes('heavy')) {
                size = getNextItemSize(size);
            }
            let [width, height] = getDefaultItemSizeDimensions(size);
            if (result.metadata.traits.includes('long')) {
                width = Math.ceil(width / 2);
                height = height + 1;
            }
            if (result.metadata.traits.includes('flat')) {
                width = width + 1;
                height = Math.ceil(height / 2);
            }
            result.w = width;
            result.h = height;

            spawnItem(result);

            e.preventDefault();
            return false;
        }

        function getNextItemSize(itemSize) {
            switch(itemSize) {
                case 'tiny': return 'small';
                case 'small': return 'medium';
                case 'medium': return 'large';
                case 'large': return 'huge';
                case 'huge': throw new Error(`No item size bigger than huge.`);
                default: throw new Error(`Unknown item size '${itemSize}'`);
            }
        }

        function getDefaultItemSizeDimensions(itemSize) {
            switch(itemSize) {
                case 'tiny': return [1, 1];
                case 'small': return [1, 1];
                case 'medium': return [2, 2];
                case 'large': return [4, 4];
                case 'huge': return [6, 6];
                default: throw new Error(`Unknown item size '${itemSize}'`);
            }
        }

        function onItemReset(e) {
            document.querySelector('#itemBuilder').reset();
        }

        function spawnItem(opts) {
            let item = createItem(getInventoryStore(), opts);
            dropOnGround(item);
        }

        function spawnDefaultBackpack() {
            spawnItem(BACKPACK);
        }

        window.addEventListener('DOMContentLoaded', () => {
            setCursorElement(document.querySelector('#holding'));
            setGroundContainer(document.querySelector('#ground'));
            spawnDefaultBackpack();
        });
    </script>
</body>

</html>