<!DOCTYPE html>
<html>

<head>
    <title>Satchel</title>

    <style>
        html, body {
            margin: 0;
        }

        body {
            display: flex;
            flex-direction: column;
            width: 100vw;
            height: 100vh;
            background-image: url("./res/images/wood.jpg");
            background-size: 30rem;
            background-repeat: repeat;
            background-color: #211B1C;
            color: #FFFFFF;
            overflow: hidden;
            font-family: Georgia, 'Times New Roman', Times, serif;
            box-shadow: inset 0 0 16rem #000000;
        }

        .foreground {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            pointer-events: none;
            overflow: hidden;
            z-index: 5;
        }

        #ground {
            position: relative;
            padding: 1rem;
            border: 1rem dashed rgba(0, 0, 0, 0.2);
        }

        #cursor > inventory-grid {
            filter: brightness(70%);
        }
    </style>
    
    <script type="module" src="./src/inventory/InventoryGrid.js"></script>
    <script type="module" src="./src/inventory/InventoryItem.js"></script>
</head>
<body>
    <style>
        body {
            display: flex;
            flex-direction: column;
        }
        .content {
            flex: 1;
            height: 0;
        }
        header, footer {
            z-index: 1;
        }
    </style>
    <header>
        <style>
            header {
                display: flex;
                flex-direction: row;
                align-items: center;
                padding: 0 2em;
            }
            .spacer {
                flex: 1;
            }
            .toolbar {
                overflow-x: auto;
            }
            .toolbar button {
                background: none;
                border: none;
            }
        </style>
        <h1>Satchel</h1>
        <div class="spacer"></div>
        <div class="toolbar">
            <style>
                .toolbar button:disabled {
                    opacity: 0.3;
                }
            </style>
            <button id="downloadButton">
                <img src="res/download.svg" alt="download" width="40">
            </button>
            <button id="cloudButton">
                <img src="res/cloud.svg" alt="cloud" width="40">
            </button>
            <button id="deleteButton">
                <img src="res/delete.svg" alt="delete" width="40">
            </button>
            <button id="settingsButton">
                <img src="res/settings.svg" alt="settings" width="40">
            </button>
            <script type="module">
                import { clearGround } from './src/inventory/GroundHelper.js';
                import { openItemBuilder } from './src/inventory/ItemBuilder.js';
                import { downloadText } from './src/Downloader.js';
                import { saveToJSON } from './src/inventory/InventoryLoader.js';
                import { getInventoryStore } from './src/inventory/InventoryStore.js';
                import { connectAsClient, connectAsServer, isServerSide } from './src/inventory/PeerSatchel.js';
                
                window.addEventListener('DOMContentLoaded', () => {
                    document.querySelector('#settingsButton').addEventListener('click', onSettingsClick);
                    document.querySelector('#deleteButton').addEventListener('click', onDeleteClick);
                    document.querySelector('#cloudButton').addEventListener('click', onCloudClick);
                    document.querySelector('#downloadButton').addEventListener('click', onDownloadClick);

                    // Try connect the client
                    connectAsClient().then(result => {
                        if (result) {
                            document.querySelector('#cloudButton').toggleAttribute('disabled', true);
                        }
                    });
                });

                function onSettingsClick() {
                    let settings = document.querySelector('#settingsContent');
                    if (settings.classList.contains('open')) {
                        settings.classList.remove('open');
                    } else {
                        openItemBuilder(document.querySelector('#itemBuilder'));
                        document.querySelector('#settingsContent').classList.add('open');
                    }
                }

                function onDeleteClick() {
                    if (window.confirm('Clear all items on the ground?')) {
                        clearGround();
                    }
                }

                function onCloudClick() {
                    // Try connect the server
                    connectAsServer();
                }

                function onDownloadClick() {
                    let timestamp = Date.now();
                    if (isServerSide()) {
                        let serverData;
                        try {
                            serverData = JSON.parse(localStorage.getItem('server_data'));
                        } catch(e) {
                            serverData = {};
                        }
                        let wrappedData = {
                            timestamp,
                            data: serverData,
                        };
                        let dataString = JSON.stringify(wrappedData, null, 4);
                        downloadText(`server-data-${timestamp}.json`, dataString);
                    } else {
                        let jsonData = saveToJSON(getInventoryStore());
                        let wrappedData = {
                            timestamp,
                            data: jsonData,
                        };
                        let dataString = JSON.stringify(wrappedData, null, 4);
                        downloadText(`satchel-data-${timestamp}.json`, dataString);
                    }
                }
            </script>
        </div>
    </header>
    <div class="content">
        <main>
            <style>
                .content {
                    position: relative;
                    text-align: center;
                    display: flex;
                }
                main {
                    overflow: auto;
                    flex: 1;
                }
                .sidebar {
                    background: #333333;
                    position: absolute;
                    top: 0;
                    right: 0;
                    max-height: 100%;
                    overflow-y: auto;
                    transform: translateX(100%);
                    transition: transform 0.3s ease;
                    border-left: 0.5em solid black;
                }
                .sidebar.open {
                    transform: translateX(0%);
                }
            </style>
            <div id="workspace">
                <!-- MAIN -->
            </div>
            <div id="ground"></div>
        </main>
        <div class="sidebar" id="settingsContent">
            <style>
                #itemDetailSet, #itemFinishSet {
                    display: flex;
                    flex-direction: column;
                }
                fieldset:disabled {
                    opacity: 0.3;
                }
                #itemName {
                    text-align: center;
                }
                input[type="text"], textarea {
                    font-family: 'Times New Roman', Times, serif;
                }
            </style>
            <form id="itemBuilder" autocomplete="off">
                <legend>Item Builder</legend>
                <fieldset id="itemSizeSet">
                    <legend>Size</legend>
                    <input type="radio" id="itemSize0" name="itemSize" value="tiny">
                    <label for="itemSize0">Tiny</label>
                    <input type="radio" id="itemSize1" name="itemSize" value="small" checked>
                    <label for="itemSize1">Small</label>
                    <input type="radio" id="itemSize2" name="itemSize" value="medium">
                    <label for="itemSize2">Medium</label>
                    <input type="radio" id="itemSize3" name="itemSize" value="large">
                    <label for="itemSize3">Large</label>
                    <input type="radio" id="itemSize4" name="itemSize" value="huge">
                    <label for="itemSize4">Huge</label>
                </fieldset>
                <fieldset id="itemTraitSet">
                    <legend>Traits</legend>
                    <input type="checkbox" id="itemTrait0" name="itemTrait" value="flat">
                    <label for="itemTrait0">Flat</label>
                    <input type="checkbox" id="itemTrait1" name="itemTrait" value="long">
                    <label for="itemTrait1">Long</label>
                    <input type="checkbox" id="itemTrait2" name="itemTrait" value="heavy">
                    <label for="itemTrait2">Heavy</label>
                </fieldset>
                <fieldset id="itemDetailSet">
                    <legend>Details</legend>
                    <input type="hidden" id="itemId" name="itemId">
                    <label for="itemName">Name</label>
                    <input type="text" id="itemName" name="itemName" value="Item">
                    <label for="itemDetail">Description</label>
                    <textarea id="itemDetail" name="itemDetail"></textarea>
                </fieldset>
                <br>
                <fieldset id="itemFinishSet">
                    <input type="submit" value="Build">
                    <button id="itemResetButton">Cancel</button>
                </fieldset>
            </form>
        </div>
    </div>
    <footer style="font-family: monospace; opacity: 0.6;">
        <small>
            Made with ‚ù§ by Andrew Kuo.
        </small>
    </footer>
    <div class="foreground" id="cursor">
        <!-- CURSOR -->
    </div>

    <script type="module" src="src/inventory/main.js"></script>
</body>

</html>